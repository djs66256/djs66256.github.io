---
title: 了解 HealthKit Medications API
date: 2025-06-10 15:26:21
categories:
- wwdc2025
tags:
- wwdc2025
- ios
- ipados
- visionos
- app-服务
---
了解 healthkit 中的全新 medications api。探索一个使用此全新 api 的示例 app，了解如何访问药品和剂量，并了解你的 app 如何管理此类新数据的授权。
<!--more-->

![视频封面](https://devimages-cdn.apple.com/wwdc-services/images/3055294D-836B-4513-B7B0-0BC5666246B0/9855/9855_wide_250x141_2x.jpg)
[视频地址](https://developer.apple.com/cn/videos/play/wwdc2025/321/)

# HealthKit药物API全面解析：从数据读取到权限管理

## 引言
随着iOS 15引入药物追踪功能，Apple的HealthKit框架为开发者提供了全新的药物管理API。这些API不仅能让用户记录用药情况，更为健康类应用开发者开辟了创新空间。本文将深入解析这些新功能，并通过实际案例展示如何高效利用这些API。

## 药物数据存储机制
自iOS 15起，健康App新增了完整的药物追踪功能。用户可以通过以下方式管理药物数据：
- 在"搜索"标签页添加新药物
- 设置个性化的服药提醒时间
- 记录每次服药状态（包括"已服用"、"跳过"或"延迟"等）

所有这些数据都安全存储在HealthKit中，为开发者提供了丰富的集成可能。

## 核心API解析
HealthKit新增了两类关键数据类型和对应的查询方式：

### 1. 药物对象(HKUserAnnotatedMedication)
药物对象包含四个核心属性：
```swift
isArchived // 标记药物是否已停用
hasSchedule // 是否设置了服药提醒
nickname // 用户自定义的药物昵称
medicationConcept // 药物临床标识信息
```

其中`medicationConcept`尤为重要，它包含：
- 唯一药物标识符
- 标准显示名称（如"阿莫西林三水合物500mg口服片剂"）
- 药物剂型（片剂/液体等）
- 临床编码（如RxNorm代码308192）

### 2. 剂量事件(HKMedicationDoseEvent)
作为新型`HKSample`，剂量事件记录：
- 服药状态（已服/跳过）
- 实际剂量与计划剂量的差异
- 通过medicationConcept关联到特定药物

## 数据查询实践
开发者可以通过以下方式查询药物数据：

1. **基本查询**：
使用`HKUserAnnotatedMedicationQueryDescriptor`和`HKUserAnnotatedMedicationQuery`获取授权药物列表

2. **条件查询**：
```swift
// 查询当日已服用的特定药物记录
let predicate = HKQuery.predicateForSamples(
    withStart: todayStart,
    end: todayEnd,
    options: .strictStartDate
)
```

3. **锚定查询**：
对于需要持续更新的数据（如服药趋势图表），推荐使用`HKAnchoredObjectQuery`，它能：
- 动态处理新增样本
- 跟踪删除的对象
- 兼容历史数据编辑

## 实战应用案例
通过一个示例应用，我们展示了API的典型使用场景：

1. **授权流程**：
请求`HKUserAnnotatedMedicationType`读取权限后，应用自动获得关联剂量事件的访问权

2. **副作用分析**：
利用RxNorm编码匹配预设的副作用模型（如头痛、恶心）

3. **症状记录**：
使用表情符号表示症状强度，保存为`HKCategorySample`

4. **数据可视化**：
构建服药依从性趋势图表，帮助用户了解用药规律

## 权限管理最佳实践
当用户在健康App添加新药物时：
1. 已请求药物权限的应用会出现在分享选项中
2. 用户可直接授权新药物，无需额外操作
3. 应用重新激活后即可立即访问新增药物数据

特别提示：对于敏感数据，应考虑使用`requiresPerObjectAuthorization()`进行细粒度控制。

## 总结与下一步
HealthKit药物API通过以下方式赋能健康应用开发：
- 连接个性化用药数据与临床标准信息
- 提供完整的用药记录生命周期管理
- 支持丰富的用药分析和提醒功能

建议开发者：
1. 下载官方示例应用研究实现细节
2. 深入了解RxNorm等临床编码系统
3. 查阅文档掌握剂量事件状态和查询谓词的使用

## 相关视频
- [使用iOS和iPadOS上的HealthKit跟踪体能训练](https://developer.apple.com/videos/play/wwdc2025/322)
- [HealthKit入门讲座](https://developer.apple.com/videos/play/wwdc2020/10664)

## 文档参考
- [健康数据访问授权](https://developer.apple.com/documentation/HealthKit/authorizing-access-to-health-data)
- [HKAnchoredObjectQuery文档](https://developer.apple.com/documentation/HealthKit/HKAnchoredObjectQuery)
- [HKSampleQuery文档](https://developer.apple.com/documentation/HealthKit/HKSampleQuery)
- [requiresPerObjectAuthorization()](https://developer.apple.com/documentation/HealthKit/HKObjectType/requiresPerObjectAuthorization())
> 此文章由AI生成，可能存在错误，如有问题，请联系[djs66256@163.com](djs66256@163.com)