---
title: 使用 iOS 和 iPadOS 上的 HealthKit 跟踪体能训练
date: 2025-06-10 15:28:03
categories:
- wwdc2025
tags:
- wwdc2025
- ios
- app-服务
---
了解有关为 ios 打造出色体能训练体验的最佳做法。探究体能训练会话的生命周期，探索 apple watch 上和 iphone 上体能训练的不同之处，并了解如何使用实时活动和 siri 来提升 app 的锁屏体验。
<!--more-->

![视频封面](https://devimages-cdn.apple.com/wwdc-services/images/3055294D-836B-4513-B7B0-0BC5666246B0/9856/9856_wide_250x141_2x.jpg)
[视频地址](https://developer.apple.com/cn/videos/play/wwdc2025/322/)

# 在 iOS 和 iPadOS 上使用 HealthKit 实现专业的体能训练追踪

## 引言

随着健康意识的提升，越来越多的用户开始关注自己的体能训练数据。通过 HealthKit，开发者可以为用户打造卓越的体能训练体验。本文将详细介绍如何在 iPhone 和 iPad 上使用 HealthKit API 来实现完整的训练追踪功能，包括训练会话的生命周期管理、健康指标采集、崩溃恢复机制以及锁屏状态下的训练控制。

## 训练会话的基础流程

### 初始化训练配置

首先需要创建一个训练配置对象，指定训练类型和位置：

```swift
let configuration = HKWorkoutConfiguration()
configuration.activityType = .running  // 训练类型设置为跑步
configuration.locationType = .outdoor  // 设置为户外训练
```

### 创建训练会话和 Builder

使用配置创建训练会话，并获取关联的 Workout Builder：

```swift
let session = try HKWorkoutSession(healthStore: healthStore, configuration: configuration)
session.delegate = self

let builder = session.associatedWorkoutBuilder()
builder.delegate = self
builder.dataSource = HKLiveWorkoutDataSource(healthStore: healthStore,
                                           workoutConfiguration: configuration)
```

### 启动训练会话

在显示倒计时后，正式启动训练：

```swift
session.prepare()  // 准备阶段
// 显示3秒倒计时后
session.startActivity(with: startDate)
try await builder.beginCollection(at: startDate)
```

### 处理实时数据

Workout Builder 会通过代理方法提供最新的训练数据：

```swift
func workoutBuilder(_ workoutBuilder: HKLiveWorkoutBuilder, 
                  didCollectDataOf collectedTypes: Set<HKSampleType>) {
    for type in collectedTypes {
        guard let quantityType = type as? HKQuantityType else { return }
        let statistics = workoutBuilder.statistics(for: quantityType)
        updateForStatistics(statistics)  // 更新UI显示
    }
}
```

### 结束训练

结束训练时需要按照正确顺序调用各个方法：

```swift
session.stopActivity(with: .now)  // 停止活动

// 在会话状态变为stopped后
try await builder.endCollection(at: change.date)
let finishedWorkout = try await builder.finishWorkout()
session.end()  // 最终结束会话
```

## iPhone/iPad 与 Apple Watch 的差异

### 传感器支持

iPhone 和 iPad 没有内置心率传感器，但可以连接支持心率 GAT 协议的外设（如 Powerbeats Pro 2）。配对后，HealthKit 会自动获取并存储心率数据。

### 数据类型分类

- **生成类型**：系统自动生成的数据（如卡路里、距离）
- **收集类型**：应用需要实时观察的数据（可通过 enableCollection/disableCollection 方法控制）

### 锁屏状态处理

在锁屏状态下，大多数健康数据不可访问。建议：
1. 首次启动时请求锁屏数据访问权限
2. 锁屏时仅显示训练时长等基本信息
3. 结合实时活动和 Siri 意图提供完整体验

## Siri 语音控制实现

### 设置意图处理器

```swift
public class IntentHandler: INExtension {}

extension IntentHandler: INStartWorkoutIntentHandling
extension IntentHandler: INPauseWorkoutIntentHandling
extension IntentHandler: INResumeWorkoutIntentHandling
extension IntentHandler: INEndWorkoutIntentHandling
```

### 处理开始训练意图

```swift
public func handle(intent: INStartWorkoutIntent) async -> INStartWorkoutIntentResponse {
    let state = await WorkoutManager.shared.state
    guard state != .running, state != .paused else {
        return INStartWorkoutIntentResponse(code: .failureOngoingWorkout, userActivity: nil)
    }
    
    Task {
        await MainActor.run {
            WorkoutManager.shared.setWorkoutConfiguration(activityType: .running, 
                                                         location: .outdoor)
        }
    }
    return INStartWorkoutIntentResponse(code: .success, userActivity: nil)
}
```

## 崩溃恢复机制

### 应用委托设置

```swift
func application(_ application: UIApplication,
               configurationForConnecting connectingSceneSession: UISceneSession,
               options: UIScene.ConnectionOptions) -> UISceneConfiguration {
    if options.shouldHandleActiveWorkoutRecovery {
        let store = HKHealthStore()
        store.recoverActiveWorkoutSession { workoutSession, error in
            Task {
                await WorkoutManager.shared.recoverWorkout(recoveredSession: workoutSession)
            }
        }
    }
    return UISceneConfiguration(name: "Default Configuration", 
                              sessionRole: connectingSceneSession.role)
}
```

### 恢复训练会话

```swift
func recoverWorkout(recoveredSession: HKWorkoutSession) {
    session = recoveredSession
    builder = recoveredSession.associatedWorkoutBuilder()
    session?.delegate = self
    builder?.delegate = self
    
    let dataSource = HKLiveWorkoutDataSource(healthStore: healthStore,
                                           workoutConfiguration: recoveredSession.workoutConfiguration)
    builder?.dataSource = dataSource
}
```

## 最佳实践

1. 优先启动 Apple Watch 端训练以获得更完整的指标数据
2. 仅请求必要的健康数据权限
3. 始终使用 Workout Builder API 创建和保存训练
4. 合理处理锁屏状态下的用户体验
5. 为关键功能添加 Siri 语音控制支持

## 结论

通过 HealthKit 的体能训练 API，开发者可以在 iPhone 和 iPad 上构建专业的训练追踪应用。新版本提供了更强大的崩溃恢复能力和锁屏控制功能。建议开发者：

1. 下载示例应用参考完整实现
2. 将现有应用迁移到 Workout Builder API
3. 利用统一 API 开拓多设备市场
4. 持续提供反馈帮助改进 API

## 相关视频

- [了解 HealthKit Medications API](https://developer.apple.com/videos/play/wwdc2025/321)
- [利用 App Intents 为用户奉上 App 的核心功能](https://developer.apple.com/videos/play/wwdc2024/10210)
- [了解 ActivityKit](https://developer.apple.com/videos/play/wwdc2023/10184)
- [构建多设备训练 App](https://developer.apple.com/videos/play/wwdc2023/10023)

## 文档

- [HKWorkoutSession 文档](https://developer.apple.com/documentation/HealthKit/HKWorkoutSession)
- [运行训练会话](https://developer.apple.com/documentation/HealthKit/running-workout-sessions)
> 此文章由AI生成，可能存在错误，如有问题，请联系[djs66256@163.com](djs66256@163.com)