---
title: 借助 NetworkExtension 优化网络流量过滤和隧道
date: 2025-06-10 15:48:34
categories:
- wwdc2025
tags:
- wwdc2025
- ios
- ipados
- macos
- tvos
- visionos
- watchos
- 系统服务
---
了解 networkextension 框架中提供的 api，这些 api 让你的 app 能够灵活地扩展系统的核心网络功能 — 例如实现网络内容过滤器、创建和管理 vpn 配置等。在 ios、ipados 和 macos 26 中，你现在可以构建更为强大的内容过滤器，让它根据整个 url (而不仅是主机名) 来做出流量决策，同时确保隐私和安全丝毫不受影响。我们将首先简要介绍 networkextension 框架的一些主要用例，包括网络中继和 vpn。然后，我们将深入探讨这一全新的 url 过滤器 api 及其关键组件，包括 private information retrieval、privacy pass 等。
<!--more-->

![视频封面](https://devimages-cdn.apple.com/wwdc-services/images/3055294D-836B-4513-B7B0-0BC5666246B0/9924/9924_wide_250x141_2x.jpg)
[视频地址](https://developer.apple.com/cn/videos/play/wwdc2025/234/)

# 深入解析 NetworkExtension：网络流量过滤与隧道技术完全指南

## 简介
NetworkExtension 是苹果平台强大的网络扩展框架，它允许开发者构建能够扩展系统核心网络功能的应用。无论是在 iOS、iPadOS 还是 macOS 上，NetworkExtension 都能为你的应用提供灵活的网络控制能力。本文将全面介绍 NetworkExtension 的主要功能，重点讲解最新 URL 过滤器 API 及其实现原理。

## NetworkExtension 功能概览
NetworkExtension 框架支持多种网络定制和扩展方式：

### Wi-Fi 管理与热点
在 iOS 上，开发者可以使用 Wi-Fi 管理和热点 API 来：
- 配置 Wi-Fi 设置
- 与热点进行交互
- 利用 iOS 26 新增的 NEHotspotHelper 扩展 API

### 本地推送 API
适用于特殊网络环境（如邮轮或医院）的应用场景，支持：
- 受限网络中的短信发送
- VoIP 通话等功能

### DNS 配置与代理
构建安全应用来保护 DNS 流量：
- 安装 DNS 配置
- 使用内置加密 DNS 协议
- 通过自有安全通道代理 DNS 流量

### 透明代理（仅 Mac）
- 将特定网站流量重定向至云端安全服务
- 进行认证授权处理

## 安全远程访问解决方案
NetworkExtension 提供两种主要远程访问方案：

### 网络中继
适合隧道传输 TCP 或 UDP 流量以访问特定应用：
- 使用 MASQUE 协议提供安全代理
- 性能优化且易于集成到现代云环境
- 平台内置支持，无需自建扩展

### 基于 IP 的 VPN
适合需要隧道传输 IP 流量的场景：
- 企业网络扩展
- 个人隐私保护
- 网络安全政策严格的受监管机构

创建 IP 型 VPN 隧道时，开发者可选择：
1. 使用 NEVPNManager API 内置协议（IKEv2 或 IPsec）
2. 使用 NEPacketTunnelProvider 实现自定义隧道协议

## 内容过滤技术
NetworkExtension 提供强大的内容过滤 API，主要用途包括：
- 个人防火墙
- 企业流量监控应用
- 家长控制应用

### 传统内容过滤器
基于流量级信息（如 HTTPS 请求的主机和端口）做决策

### 新型 URL 过滤器（iOS 26+）
基于完整 URL 进行系统级 HTTP/HTTPS 请求过滤

## URL 过滤器工作原理
URL 过滤器采用创新隐私保护技术，确保：
- 应用无法获取 URL 内容
- 所有后端服务器查询均匿名化
- 整个后端链都无法访问内容与身份信息

### 核心技术组件
1. **Bloom 过滤器**：快速预过滤设备端数据
2. **私有信息检索（PIR）**：加密查询服务器数据库
3. **Privacy Pass**：服务器匿名认证
4. **Oblivious HTTP 中继**：隐私保护代理

### 工作流程
1. 浏览器发起 URL 请求
2. 系统用 Bloom 过滤器检查
3. 阳性匹配时系统向 PIR 服务器发送加密查询
4. 服务器执行加密数据库查询并返回结果
5. 系统解密响应并决定是否拒绝请求

## 实现 URL 过滤器
开发者可以通过以下步骤创建 URL 过滤器：

### 1. 设置 PIR 服务器
使用示例代码快速搭建服务器

### 2. 构建 Bloom 过滤器
根据数据集动态性决定交付方式：
- 静态数据集：包含在应用包中
- 动态数据集：从服务器定期更新

### 3. 构建 URL 过滤器应用
添加必要的权限和配置：
```swift
import NetworkExtension

let manager = NEURLFilterManager.shared

try await manager.loadFromPreferences()

try manager.setConfiguration(
    pirServerURL: URL(string:"https://pir.example.com")!,
    pirPrivacyPassIssuerURL: URL(string:"https://privacypass.example.com")!,
    pirAuthenticationToken: "1234",
    controlProviderBundleIdentifier: "com.example.myURLFilter.extension")

manager.prefilterFetchInterval = 86400 // 每日获取一次
manager.shouldFailClosed = false
manager.localizedDescription = "Alice的URL过滤器"
manager.isEnabled = true

try await manager.saveToPreferences()
```

### 4. 企业级部署
通过 MDM 推送包含 URL 过滤器参数的配置描述文件

### 5. 构建应用扩展
使用 Xcode 新模板实现 NEURLFilterControlProvider 协议

## 最佳实践建议
- 使用网络中继安全远程访问 TCP/UDP 流量
- 用 NetworkExtension 构建 VPN 解决方案
- 通过 URL 过滤器 API 创建内容过滤器
- 避免使用 Packet Filter 或直接修改路由表

## 相关视频
- [将隐私保护融入开发流程](https://developer.apple.com/videos/play/wwdc2025/246)
- [适用于现代 Mac 的网络扩展](https://developer.apple.com/videos/play/wwdc2019/714)

## 文档资源
- [通过URL过滤流量](https://developer.apple.com/documentation/NetworkExtension/filtering-traffic-by-url)
- [NEHotspotManager](https://developer.apple.com/documentation/NetworkExtension/NEHotspotManager)
- [Network Extension](https://developer.apple.com/documentation/NetworkExtension)
- [NEURLFilterManager](https://developer.apple.com/documentation/NetworkExtension/NEURLFilterManager)
> 此文章由AI生成，可能存在错误，如有问题，请联系[djs66256@163.com](djs66256@163.com)