---
title: StoreKit 和 App 内购买项目的新功能
date: 2025-06-10 15:26:36
categories:
- wwdc2025
tags:
- wwdc2025
- ios
- ipados
- macos
- tvos
- visionos
- watchos
- app-store、分发与营销
---
了解最新的 storekit api 增强功能，它们有助于你为顾客提供出色的 app 内购买项目体验。我们将介绍 apptransaction、transaction 和 renewalinfo 中新增的字段，以及针对 app 内购买项目优惠代码所做的更新。我们还将介绍如何使用 app store server library 创建已签名的 app 内购买项目请求，以及如何使用 swiftui 来更新陈列订阅项。
<!--more-->

![视频封面](https://devimages-cdn.apple.com/wwdc-services/images/3055294D-836B-4513-B7B0-0BC5666246B0/9940/9940_wide_250x141_2x.jpg)
[视频地址](https://developer.apple.com/cn/videos/play/wwdc2025/241/)

# StoreKit 与 App 内购买新功能全面解析

## 引言
苹果在最新的 StoreKit API 中引入了一系列增强功能，旨在帮助开发者提供更卓越的应用内购买体验。本文将详细介绍 AppTransaction、Transaction 和 RenewalInfo 的新增字段，解析优惠代码的使用更新，并演示如何利用 App Store Server Library 创建已签名的购买请求，以及如何使用 SwiftUI 优化订阅项展示。

## 核心框架新特性

### AppTransaction 更新
AppTransaction 提供应用原始购买的关键信息，包括：
- 客户首次购买日期
- 下载的应用版本号
- 预购日期（如适用）

新版本新增了两个重要字段：
1. `appTransactionID`（兼容iOS 15+）：每个Apple ID下载您应用的全局唯一标识符，支持家庭共享场景下的成员唯一识别
2. `originalPlatform`（iOS 18.4+）：显示客户最初购买应用的平台（iOS/macOS/tvOS/visionOS），帮助应对商业模型变更

```swift
// 获取AppTransaction示例
let appTransaction = try await AppTransaction.shared
```

### Transaction 更新
Transaction代表成功的应用内购买，新增：
- `appTransactionID`
- `Offer Period`（优惠对应的订阅周期）
- `advancedCommerceInfo`（适用于Advanced Commerce API）

iOS 18.4用`currentEntitlements`API取代了旧的`productID`查询，能返回用户有权访问的所有交易记录。

### RenewalInfo 更新
专用于自动续订订阅，新增四个字段：
- `appTransactionID`
- `Offer Period`
- `advancedCommerceInfo`
- `appAccountToken`（关联用户账户）

## 优惠码功能增强
今年优惠码支持范围扩大至：
- 消耗型商品
- 非消耗型商品
- 非续订订阅

用户可通过`offerCodeRedemption`API在应用内兑换。自动续订订阅的优惠码兑换支持到iOS 14.2。新增`oneTime`支付模式（兼容iOS 17.2+）。

## 签署购买请求实践
采用JSON签名的新API流程：
1. 从App Store Connect获取内购签名密钥
2. 初始化签名上下文
3. 调用创建签名函数

推荐使用开源的App Store Server Library（支持Java/Python/Node.js/Swift）简化签名流程。

```swift
// 促销优惠示例
SubscriptionPromotionalOffer(
    offerID: "special_offer",
    keyID: "your_key_id",
    nonce: UUID(),
    signature: "signature_data",
    timestamp: Date().timeIntervalSince1970
)
```

## 订阅展示优化
新增SwiftUI视图`SubscriptionOfferView`，特点：
- 支持通过产品ID或订阅组ID初始化
- 可选App Store Connect预设图标或自定义图标
- `visibleRelationship`参数控制展示关系（升级/降级/同级/当前/全部）

实现建议：
```swift
SubscriptionOfferView(subscriptionGroupID: "premium_group") {
    // 自定义内容
}
.subscriptionOfferViewDetailAction { product in
    // 处理详情点击
}
```

## 迁移建议
推荐开发者：
1. 采用StoreKit视图构建应用商店
2. 集成App Store Server Library简化签名
3. 利用新API优化订阅管理流程

## 相关视频
- [App Store Connect 的新功能](https://developer.apple.com/videos/play/wwdc2025/328)
- [探索适用于 App 内购买项目的 App Store Server API](https://developer.apple.com/videos/play/wwdc2024/10062)
- [认识 StoreKit 与 SwiftUI](https://developer.apple.com/videos/play/wwdc2023/10013)
- [认识 StoreKit 2](https://developer.apple.com/videos/play/wwdc2021/10114)

## 文档资源
- [Advanced Commerce API](https://developer.apple.com/in-app-purchase/advanced-commerce-api/)
- [人机界面指南：应用内购买](https://developer.apple.com/design/human-interface-guidelines/in-app-purchase)
- [设置优惠码](https://developer.apple.com/help/app-store-connect/manage-subscriptions/set-up-offer-codes/)
- [App Store Server Library](https://developer.apple.com/documentation/AppStoreServerAPI/simplifying-your-implementation-by-using-the-app-store-server-library)
- [StoreKit文档](https://developer.apple.com/documentation/StoreKit)
> 此文章由AI生成，可能存在错误，如有问题，请联系[djs66256@163.com](djs66256@163.com)