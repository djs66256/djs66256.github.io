---
title: 深入探索 Metal 4 游戏
date: 2025-06-10 15:37:45
categories:
- wwdc2025
tags:
- wwdc2025
- ios
- ipados
- macos
- tvos
- visionos
- 图形和游戏
---
深入了解 metal 4 的最新改进。我们将介绍全新光线追踪功能，助你将复杂度极高且视觉效果丰富的工作负载成功移植到 apple 芯片上。了解 metalfx 如何通过渲染画质提升、帧插值和场景去噪来扩展工作负载。

为了充分从这个讲座中获益，我们建议你先观看“探索 metal 4”和“探索 metal 4 游戏”。
<!--more-->

![视频封面](https://devimages-cdn.apple.com/wwdc-services/images/3055294D-836B-4513-B7B0-0BC5666246B0/9888/9888_wide_250x141_2x.jpg)
[视频地址](https://developer.apple.com/cn/videos/play/wwdc2025/211/)

# Metal 4 游戏开发进阶指南：光线追踪、MetalFX 与性能优化

## 引言
现代游戏开发正朝着更逼真的视觉效果发展，而 Metal 4 为开发者提供了实现这一目标的强大工具。本文将深入探讨 Metal 4 的最新特性，包括光线追踪增强、MetalFX 超采样和帧插值技术，帮助您在 Apple 平台上打造高性能的沉浸式游戏体验。

## MetalFX 超采样技术

### 时域超采样基础
MetalFX 基于机器学习的超采样器自 2022 年就成为 Apple 平台的一部分。它通过在渲染管线中应用时域技术，显著提升游戏质量和性能。关键步骤包括：
- 正确设置曝光输入参数
- 合理应用抖动渲染
- 在后处理效果前集成超采样

```swift
// 创建典型时域超采样器的示例代码
let descriptor = MTLCreateMetalFXSpatialScalerDescriptor()
descriptor.colorTextureFormat = colorFormat
descriptor.outputTextureFormat = outputFormat
let spatialScaler = device.makeMetalFXSpatialScaler(descriptor: descriptor)
```

### 曝光调试工具
今年新增的曝光调试工具可帮助调整曝光输入值。启用环境变量 `MTLFX_EXPOSURE_TOOL_ENABLED` 后，超采样器会在画面上渲染灰色棋盘格图案。正确曝光值时，网格图案应保持稳定的中灰色。

### 动态分辨率与反应性蒙版
MetalFX 时域超采样器现在支持：
- 动态尺寸输入：无需每帧固定尺寸
- 反应性像素提示：通过可选的反应性蒙版输入标记透明特效或粒子覆盖区域

## MetalFX 帧插值技术

### 工作原理
帧插值技术利用已渲染像素在两帧之间生成插值帧，需要提供：
- 两帧渲染画面
- 运动矢量
- 深度数据

### UI 渲染策略
启用帧插值时，有三种常用 UI 渲染技术：
1. 复合 UI 模式：插值器尝试分离带 UI 和不带 UI 的帧差值
2. 离屏 UI：将 UI 渲染到独立纹理中
3. 逐帧 UI：由代码完全控制，实现最流畅体验

```swift
// 创建帧插值器的示例代码
let descriptor = MTLCreateMetalFXTemporalScalerDescriptor()
descriptor.motionVectorTextureFormat = motionFormat
descriptor.depthTextureFormat = depthFormat
let temporalScaler = device.makeMetalFXTemporalScaler(descriptor: descriptor)
```

## Metal 4 光线追踪增强

### 相交函数缓冲器
Metal 4 引入相交函数缓冲器，是包含场景相交函数句柄的参数缓冲器。设置步骤包括：
- 在实例级别和几何级别配置状态
- 创建实例加速结构时指定 intersectionFunctionTableOffset
- 在着色器中添加"intersection_function_buffer"标签

### 加速结构优化
Metal 4 提供多种加速结构构建选项：
- 优先快速相交以减少光线追踪时间
- 最小化加速结构内存占用
- 支持更大场景或更快构建

## MetalFX 降噪超采样

### 集成方法
集成降噪超采样器只需在超采样器基础上添加：
- 世界空间法线
- 漫反射 albedo
- 粗糙度值
- 镜面 albedo

```swift
// 创建降噪超采样器的示例代码
let descriptor = MTLCreateMetalFXDenoiserDescriptor()
descriptor.inputTextureFormats = [colorFormat, normalFormat, albedoFormat]
let denoiser = device.makeMetalFXDenoiser(descriptor: descriptor)
```

### 常见问题与优化
- 避免输入噪点过多：使用标准路径追踪采样改进技术
- 处理金属材质：确保镜面 albedo 有颜色时，漫反射 albedo 较暗
- 使用世界空间法线：以优化降噪决策

## 结论与后续步骤
Metal 4 为游戏开发者提供了强大的工具链，从光线追踪到MetalFX性能优化技术。建议开发者：
1. 已集成超采样器的项目可升级到帧插值
2. 新项目应从MetalFX超采样技术开始
3. 优化光线追踪效果使用相交函数缓冲器等最佳实践
4. 通过降噪超采样器减少光线预算

## 相关视频
- [探索 Metal 4](https://developer.apple.com/videos/play/wwdc2025/205)
- [探索 Metal 4 游戏](https://developer.apple.com/videos/play/wwdc2025/254)
- [用于打造沉浸式 App 的 Metal 渲染的新功能](https://developer.apple.com/videos/play/wwdc2025/294)
- [Metal 光线追踪指南](https://developer.apple.com/videos/play/wwdc2023/10128)
- [利用 MetalFX Upscaling 提升性能](https://developer.apple.com/videos/play/wwdc2022/10103)
> 此文章由AI生成，可能存在错误，如有问题，请联系[djs66256@163.com](djs66256@163.com)