---
title: 跟着视频学编程：使用 SwiftUI 和 AttributedString 精心打造富文本体验
date: 2025-06-10 15:29:56
categories:
- wwdc2025
tags:
- wwdc2025
- ios
- ipados
- macos
- visionos
- swift
---
了解如何使用 swiftui 的 texteditor api 和 attributedstring 构建富文本体验。探索如何启用富文本编辑功能、构建用来操控编辑器内容的自定控件，并对提供的众多格式选项进行自定。了解 attributedstring 的高级功能，以便精心打造超棒的文本编辑体验。
<!--more-->

![视频封面](https://devimages-cdn.apple.com/wwdc-services/images/3055294D-836B-4513-B7B0-0BC5666246B0/9982/9982_wide_250x141_2x.jpg)
[视频地址](https://developer.apple.com/cn/videos/play/wwdc2025/280/)

# 使用 SwiftUI 和 AttributedString 打造富文本编辑器  

## 引言  

在现代应用开发中，富文本编辑功能已成为提升用户体验的重要环节。SwiftUI 与 AttributedString 的结合，为开发者提供了构建强大富文本编辑器的绝佳工具。本文将详细介绍如何利用这些技术，从基础实现到高级定制，打造完美的文本编辑体验。

## 基础实现：从纯文本到富文本  

### 纯文本编辑器  

```swift
import SwiftUI

struct RecipeEditor: View {
    @Binding var text: String

    var body: some View {
        TextEditor(text: $text)
    }
}
```

这是最基本的文本编辑器实现，仅支持纯文本编辑。

### 升级为富文本支持  

```swift
struct RecipeEditor: View {
    @Binding var text: AttributedString

    var body: some View {
        TextEditor(text: $text)
    }
}
```

只需将String改为AttributedString，编辑器立即获得以下能力：
- 支持粗体/斜体等格式切换
- 调整字号、插入Genmoji表情
- 完美适配深色模式和动态类型
- 兼容SwiftUI的Text显示

## AttributedString基础  

AttributedString由字符序列和属性区间组成。例如：

```swift
var text = AttributedString("Hello 👋🏻! Who's ready to get ")
var cooking = AttributedString("cooking")
cooking.foregroundColor = .orange
text += cooking
text += AttributedString("?")
text.font = .largeTitle
```

AttributedString是值类型，采用UTF-8编码，并符合Equatable、Hashable等Swift协议。

## 构建自定义控件  

### 常见错误示例  

```swift
struct RecipeEditor: View {
    @Binding var text: AttributedString
    @State private var selection = AttributedTextSelection()

    var body: some View {
        TextEditor(text: $text, selection: $selection)
            .preference(key: NewIngredientPreferenceKey.self, value: newIngredientSuggestion)
    }

    private var newIngredientSuggestion: IngredientSuggestion {
        let name = text[selection.indices(in: text)] // 编译错误
        return IngredientSuggestion(suggestedName: AttributedString())
    }
}
```

问题在于selection.indices返回的是RangeSet而非单一Range，这是为了支持双向文本布局。

### 正确实现方式  

```swift
private var newIngredientSuggestion: IngredientSuggestion {
    let name = text[selection] // 直接使用selection
    return IngredientSuggestion(suggestedName: AttributedString(name))
}
```

## 自定义文本格式  

### 定义专属格式  

```swift
struct RecipeFormattingDefinition: AttributedTextFormattingDefinition {
    struct Scope: AttributeScope {
        let foregroundColor: AttributeScopes.SwiftUIAttributes.ForegroundColorAttribute
        let adaptiveImageGlyph: AttributeScopes.SwiftUIAttributes.AdaptiveImageGlyphAttribute
        let ingredient: IngredientAttribute
    }

    var body: some AttributedTextFormattingDefinition<Scope> {
        IngredientsAreGreen() // 配料文本显示为绿色
    }
}
```

### 实现格式约束  

```swift
struct IngredientsAreGreen: AttributedTextValueConstraint {
    func constrain(_ container: inout Attributes) {
        container.foregroundColor = container.ingredient != nil ? .green : nil
    }
}
```

### 高级属性控制  

```swift
struct IngredientAttribute: CodableAttributedStringKey {
    static let inheritedByAddedText = false // 新增文本不继承属性
    static let invalidationConditions: Set<AttributedString.AttributeInvalidationCondition>? = [.textChanged] // 文本修改时移除属性
}
```

这种设置确保：
- 在配料文本后输入时，新文本不会变绿
- 删除配料字符时，整个单词立即恢复默认颜色

## 结论  

SwiftUI与AttributedString的结合为富文本编辑提供了强大而灵活的解决方案。从基础实现到高级定制，开发者可以构建出满足各种需求的文本编辑器。无论是简单的格式调整，还是复杂的业务逻辑，这套技术栈都能完美应对。

## 相关视频  
- [提升App的多语言体验](https://developer.apple.com/videos/play/wwdc2025/222)  
- [向左语言](https://developer.apple.com/videos/play/wwdc2022/10107)  
- [Foundation中的新功能](https://developer.apple.com/videos/play/wwdc2021/10109)  

## 文档  
- [AttributedTextFormatting](https://developer.apple.com/documentation/SwiftUI/AttributedTextFormatting)  
- [AttributedTextSelection](https://developer.apple.com/documentation/SwiftUI/AttributedTextSelection)  
- [Character](https://developer.apple.com/documentation/Swift/Character)
> 此文章由AI生成，可能存在错误，如有问题，请联系[djs66256@163.com](djs66256@163.com)