---
title: 进一步了解声明式网页推送
date: 2025-06-10 21:46:47
categories:
- wwdc2025
tags:
- wwdc2025
- ios
- ipados
- macos
- visionos
- safari-浏览器和网页
---
了解声明式网页推送如何帮助你更可靠地发送通知。了解如何借鉴现有标准实现更高效、更透明的设计，同时保证与原始网页推送的向后兼容性。
<!--more-->

![视频封面](https://devimages-cdn.apple.com/wwdc-services/images/3055294D-836B-4513-B7B0-0BC5666246B0/9933/9933_wide_250x141_2x.jpg)
[视频地址](https://developer.apple.com/cn/videos/play/wwdc2025/235/)
> 此文章由AI生成，可能存在错误，如有问题，请联系[djs66256@163.com](djs66256@163.com)

# 声明式网页推送：更高效可靠的通知解决方案

## 引言

推送通知已成为现代网页和移动应用不可或缺的功能。从2009年iPhone OS 3首次引入推送通知以来，这项技术已发展成为各平台的标配功能。WebKit架构团队工程师Brady Eidson在WWDC上详细介绍了网页推送通知的最新进展——声明式网页推送（Declarative Web Push），这一创新旨在提供更高效、更透明且更可靠的通知解决方案。

## 原始Web Push的局限性

传统的Web Push完全依赖JavaScript驱动，具体流程包括：

1. 需要安装Service Worker处理推送事件
2. 获取推送订阅后将信息发送到服务器
3. 服务器使用订阅URL发送推送消息
4. 浏览器启动Service Worker处理push事件
5. Service Worker调用showNotification API显示通知
6. 用户点击通知后再次启动Service Worker处理点击事件

这种设计的灵活性虽然高，但也带来诸多问题：

- **性能开销**：每次推送都需要运行JavaScript代码
- **隐私风险**：网站数据可能成为用户追踪的媒介
- **可靠性问题**：复杂代码链增加了出错概率

## 声明式网页推送的工作原理

声明式网页推送借鉴了iOS和macOS原生推送的设计理念，通过标准化JSON格式描述通知，大幅减少了JavaScript代码的需求。其核心优势包括：

1. **简化的订阅获取**：PushManager可直接在window对象上使用，无需先安装Service Worker
2. **自动化的通知处理**：浏览器直接解析JSON格式的推送消息并自动显示通知
3. **渐进式增强**：与现有Web Push标准保持兼容

## 声明式JSON格式详解

有效的声明式推送消息必须包含：

```json
{
  "web_push": "8-0-3-0",
  "notification": {
    "title": "通知标题",
    "body": "通知内容",
    "data": {
      "url": "https://example.com"
    }
  }
}
```

其中`web_push: "8-0-3-0"`是识别声明式推送的"魔法键"。该格式支持完整的NotificationOptions选项，包括：

- 标题和正文文本
- 通知标签
- 默认提示音
- 应用徽章更新
- 点击导航URL

## 高级功能：可变通知处理

对于需要客户端处理的特殊场景（如端到端加密消息），声明式推送支持`mutable: true`标记：

```json
{
  "web_push": "8-0-3-0",
  "notification": {
    "title": "加密消息",
    "body": "需要解密的内容",
    "data": {
      "encrypted": true,
      "payload": "..."
    }
  },
  "mutable": true
}
```

当Service Worker接收到这类推送时，可以解密内容并替换原始通知：

```javascript
self.addEventListener('push', event => {
  if (event.data.json().mutable) {
    const original = event.data.json().notification;
    const decrypted = decryptMessage(original.body);
    event.waitUntil(
      self.registration.showNotification(decrypted.title, {
        body: decrypted.content,
        data: { url: original.data.url }
      })
    );
  }
});
```

## 向后兼容性设计

声明式网页推送完美兼容现有Web Push系统：

1. 不支持声明式的浏览器会回退到原始Web Push处理流程
2. 已使用原始Web Push的网站可以逐步迁移
3. JSON格式可以同时满足新旧两种处理方式

迁移步骤建议：
1. 重构推送消息为声明式标准格式
2. 简化Service Worker代码仅处理必要逻辑
3. 逐步添加声明式特定功能

## 可用性与资源

声明式网页推送已在以下版本中提供支持：
- macOS Safari 18.5+
- iOS 18.4+
- iPadOS 18.4+

开发者可以利用相关资源进一步学习：
- [在网页上验证身份证件](https://developer.apple.com/videos/play/wwdc2025/232)
- [Safari浏览器和WebKit的新功能](https://developer.apple.com/videos/play/wwdc2025/233)
- [Safari浏览器网页推送功能简介](https://developer.apple.com/videos/play/wwdc2022/10098)

## 结论

声明式网页推送代表了Web通知技术的重大进步，它结合了原生推送的高效性和Web的开放性。通过减少JavaScript依赖、标准化消息格式和保持向后兼容，它为开发者提供了更可靠的解决方案，同时为用户带来更好的隐私保护和性能体验。无论是新建项目还是现有系统迁移，现在都是采用声明式推送的理想时机。
