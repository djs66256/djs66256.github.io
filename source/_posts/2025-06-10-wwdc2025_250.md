---
title: 将结构化并发代码与 Network 框架搭配使用
date: 2025-06-10 15:48:41
categories:
- wwdc2025
tags:
- wwdc2025
- ios
- ipados
- macos
- tvos
- visionos
- watchos
- 系统服务
---
network 框架是在 apple 平台上建立底层网络连接的最佳方式，而在 ios、ipados、和 macos 26 上，它非常适合与你的结构化并发代码搭配使用。我们将探索如何建立连接、发送和接收数据与分帧处理的信息、监听传入连接以及浏览网络上的服务。在此期间，我们还将介绍一些关键的最佳做法。
<!--more-->

![视频封面](https://devimages-cdn.apple.com/wwdc-services/images/3055294D-836B-4513-B7B0-0BC5666246B0/9923/9923_wide_250x141_2x.jpg)
[视频地址](https://developer.apple.com/cn/videos/play/wwdc2025/250/)

# 结构化并发中的 Network 框架实践指南

## 引言
在 iOS/macOS 应用开发中，网络连接是实现现代应用功能的核心组件。随着 iOS 和 macOS 26 系统的发布，Network 框架与 Swift 结构化并发特性的深度整合，为开发者带来了全新的网络编程体验。本文将系统性地介绍如何利用这些改进来创建更高效、安全的网络连接。

## 连接建立新范式
Network 框架彻底重构了传统的网络连接方式：

- **智能地址解析**："Connect by Name"功能自动处理域名解析
- **动态路由优化**："Happy Eyeballs"算法自动选择最优网络路径
- **原生安全协议**：内置 TLS 支持，无需依赖第三方库
- **网络适应性**：自动处理网络接口切换和代理配置

```swift
// 建立TLS连接的现代写法
let connection = NetworkConnection(to: .hostPort(host: "www.example.com", port: 1029)) {
    TLS()
}
```

## 数据收发最佳实践
Network 框架提供了多种数据交换方式：

### 基础收发
```swift
// 发送数据
try await connection.send(outgoingData)

// 精确接收指定字节数
let incomingData = try await connection.receive(exactly: 98).content
```

### 流式处理
对于未知长度的数据（如媒体文件），可采用渐进式接收策略：
```swift
while remaining > 0 {
    let chunk = try await connection.receive(atLeast: 1, atMost: remaining).content
    // 处理数据块
}
```

### 结构化消息传输
iOS 26 引入的 TLV（类型-长度-值）分帧器简化了协议设计：
```swift
// 定义消息类型
enum GameMessage: Int {
    case selectedCharacter = 0
    case move = 1
}

// 发送带类型的消息
try await connection.send(characterData, type: GameMessage.selectedCharacter.rawValue)
```

## 高级网络功能

### 入站连接处理
NetworkListener 提供了简洁的服务器端实现：
```swift
NetworkListener {
    TLS()
}.run { connection in
    // 处理每个入站连接
}
```

### 设备发现
iOS 26 新增的 NetworkBrowser 支持 Wi-Fi Aware 点对点发现：
```swift
let endpoint = try await NetworkBrowser(for: .wifiAware(...)).run { 
    .finish($0.first!) 
}
```

## 协议选择建议
- **第三方服务**：遵循行业标准协议
- **自有设备**：优先使用 Codable over TLS/QUIC
- **现有应用**：URLSession 用户可保持现状

## 总结
iOS/macOS 26 的 Network 框架三大核心改进：
1. NetworkConnection：支持现代传输协议和结构化数据
2. NetworkListener：简化服务器实现
3. NetworkBrowser：增强设备发现能力

这些改进使得网络代码更简洁、更安全，同时完全兼容结构化并发范式。

## 相关视频
- [借助 Wi-Fi Aware 增强设备连接性能](https://developer.apple.com/videos/play/wwdc2025/228)
- [采用 Swift 并发](https://developer.apple.com/videos/play/wwdc2025/268)
- [Introducing Network.framework: A modern alternative to Sockets](https://developer.apple.com/videos/play/wwdc2018/715)

## 文档
- [Network 框架文档](https://developer.apple.com/documentation/Network)
- [NetworkBrowser](https://developer.apple.com/documentation/Network/NetworkBrowser)
- [NetworkConnection](https://developer.apple.com/documentation/Network/NetworkConnection)
- [NetworkListener](https://developer.apple.com/documentation/Network/NetworkListener)
> 此文章由AI生成，可能存在错误，如有问题，请联系[djs66256@163.com](djs66256@163.com)