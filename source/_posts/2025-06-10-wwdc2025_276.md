---
title: BNNS Graph 的新功能
date: 2025-06-10 15:42:00
categories:
- wwdc2025
tags:
- wwdc2025
- ios
- ipados
- macos
- 机器学习与-ai
---
借助 bnns graph builder api，开发者现在可以使用熟悉的 swift 语言来编写操作图，从而生成预处理和后处理例程以及小型机器学习模型。bnns 可在执行前先编译图形，并支持那些具有实时性和延迟敏感性的应用场景，例如音频处理。在本次讲座中，我们将重温去年的比特失真器示例，通过移除对单独 python 文件的依赖性来简化 swift 组件，并转而完全用 swift 实现音频效果。此外，bnns graph builder api 还适用于在将图像数据传递到机器学习模型之前对数据进行预处理。本次讲座还将演示如何裁剪一张带有 alpha 通道的图像中的透明像素。
<!--more-->

![视频封面](https://devimages-cdn.apple.com/wwdc-services/images/3055294D-836B-4513-B7B0-0BC5666246B0/9977/9977_wide_250x141_2x.jpg)
[视频地址](https://developer.apple.com/cn/videos/play/wwdc2025/276/)

# 使用 BNNS Graph Builder API 实现高效机器学习推理

## 引言

在机器学习领域，推理性能至关重要。苹果推出的 BNNS Graph Builder API 为开发者提供了一种在 Swift 中构建高效推理管道的全新方式。本文将详细介绍这项技术的核心优势和使用方法，帮助您在音频处理、图像预处理等场景中实现低延迟、高性能的机器学习解决方案。

## BNNS Graph 核心优势

BNNS (Basic Neural Network Subroutines) 是苹果提供的高性能机器学习库，特别适合以下场景：
- 实时音频处理（如人声分离、音色转换）
- 图像预处理/后处理
- 延迟敏感型推理任务

BNNS Graph 通过以下方式优化性能：
- 将整个网络视为单一图对象进行全局优化
- 自动执行层融合、数学变换等优化
- 精细控制内存分配和多线程

## BNNS Graph Builder 新特性

### Swift 原生支持

新推出的 BNNS Graph Builder API 允许开发者完全使用 Swift 构建操作图：

```swift
let context = try BNNSGraph.makeContext { builder in
    let x = builder.argument(name: "x", dataType: Float.self, shape: [8])
    let y = builder.argument(name: "y", dataType: Float.self, shape: [8])
    let product = x * y
    let mean = product.mean(axes: [0], keepDimensions: true)
    return [product, mean]
}
```

优势包括：
- 编译时类型检查
- 运行时形状推断
- 中间张量可调试
- 强类型减少运行时错误

### 高效切片操作

新增的切片功能支持零拷贝数据选择：

```swift
let result = src[
    BNNSGraph.Builder.SliceRange(startIndex: verticalMargin, endIndex: -verticalMargin),
    BNNSGraph.Builder.SliceRange(startIndex: horizontalMargin, endIndex: -horizontalMargin),
    BNNSGraph.Builder.SliceRange.fillAll
]
```

## 实际应用案例

### 图像预处理

将连续色调图像二值化：

```swift
let thresholded = src .> src.mean(axes: [0,1], keepDimensions: false)
```

### 模型后处理

执行 softmax 和 topK 操作：

```swift
let softmax = x.softmax(axis: 1)
let topk = softmax.topK(k, axis: 1, findLargest: true)
```

### 音频处理改进

将 Bitcrusher 效果改用 Swift 实现：

```swift
typealias BITCRUSHER_PRECISION = Float16
var destination = (source * saturationGain).tanh()
```

## 使用建议

1. 对于现有 PyTorch 模型，仍推荐使用基于文件的 API
2. 对于小型模型或操作图，优先使用 Swift 原生 API
3. 实时音频处理优先考虑 FP16 数据类型

## 总结

BNNS Graph Builder API 提供了：
- 更直观的 Swift 开发体验
- 更高的运行时性能
- 更低的推理延迟
- 更广泛的应用场景

## 相关视频

- [探索 Apple 平台上的机器学习和 AI 框架](https://developer.apple.com/videos/play/wwdc2025/360)
- [在 CPU 上助力实现实时 ML 推理](https://developer.apple.com/videos/play/wwdc2024/10211)

## 文档

- [BNNS 官方文档](https://developer.apple.com/documentation/Accelerate/bnns-library)
- [vImage.PixelBuffer 文档](https://developer.apple.com/documentation/Accelerate/vImage/PixelBuffer)
> 此文章由AI生成，可能存在错误，如有问题，请联系[djs66256@163.com](djs66256@163.com)