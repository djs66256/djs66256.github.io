---
title: 完成后台任务
date: 2025-06-10 15:49:27
categories:
- wwdc2025
tags:
- wwdc2025
- ios
- ipados
- 系统服务
---
探索后台任务执行方面的最新进展，并了解系统如何进行运行时调度。我们将讨论如何充分利用后台运行时，让你的 app 既能在后台提供功能，又能保持出色的前台体验。我们还将介绍各种 api 如何为你的 app 提供后台运行时环境，以及每个 api 是怎样针对不同用例量身定制的 — 其中包括 ios 和 ipados 26 中的新 api，这些 api 让你的 app 能够在从前台过渡到后台时顺利完成任务。
<!--more-->

![视频封面](https://devimages-cdn.apple.com/wwdc-services/images/3055294D-836B-4513-B7B0-0BC5666246B0/9921/9921_wide_250x141_2x.jpg)
[视频地址](https://developer.apple.com/cn/videos/play/wwdc2025/227/)

# iOS后台任务处理全指南：从基础到持续处理任务

## 引言
在iOS应用开发中，后台任务处理一直是开发者需要重点关注的技术点。合理利用后台运行时可以让应用体验更流畅，同时又能保护电池寿命和系统性能。本文将系统介绍iOS后台任务处理的各个方面，包括基础概念、行为规范、常用API以及iOS 26中新增的持续处理任务。

## 基础概念

### 前台与后台状态
iOS应用主要有两种运行状态：
- **前台状态**：应用界面占据设备焦点，可以自由使用系统资源
- **后台状态**：用户离开应用但进程仍存活，默认会被挂起以节省资源

系统会在以下情况分配后台运行时间：
- 完成关键工作（如保存数据）
- 执行预加载或同步任务
- 处理用户触发的长时间操作

## 后台任务的行为规范

### 系统约束条件
iOS系统对后台任务有严格限制，主要考虑以下因素：
1. **电池寿命**：系统会合并任务，减少不必要的后台活动
2. **资源分配**：内存、CPU、网络带宽等资源优先分配给前台应用
3. **用户控制**：用户可以通过设置调节后台行为

### 设计原则
优秀后台任务应遵循以下原则：
- **高效性**：任务应轻量且目的明确
- **原子性**：将工作分解为独立单元
- **弹性**：支持断点续传
- **礼貌性**：尊重用户设置和偏好
- **自适应性**：根据系统状况调整行为

## 后台任务API详解

### 1. BGAppRefreshTask
适用于从服务器静默获取内容的场景：
```swift
import BackgroundTasks
import SwiftUI

@main
struct ColorFeed: App {
    var body: some Scene {
        WindowGroup {
            // ...
        }
        .backgroundTask(.appRefresh("com.colorfeed.wwdc25.appRefresh")) {
            await self.handleAppRefreshTask()
        }
    }
}
```

### 2. BGProcessingTask
适用于数据处理、数据库维护等场景：
```swift
import BackgroundTasks
import UIKit

class AppDelegate: UIResponder, UIApplicationDelegate {
    func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
        BGTaskScheduler.shared.register(
            forTaskWithIdentifier: "com.example.apple-samplecode.ColorFeed.db_cleaning",
            using: nil
        ) { task in
            self.handleAppRefresh(task: task as! BGProcessingTask)
        }
    }
}
```

### 3. 传统后台任务API
适用于完成关键不可中断的工作：
```swift
import UIKit

@main
class AppDelegate: UIResponder, UIApplicationDelegate {
    var backgroundTaskID: UIBackgroundTaskIdentifier = .invalid
   
    func saveState() { /* ... */ }

    func handlePersistence() {
        let app = UIApplication.shared
        guard backgroundTaskID != .invalid else { return }
        backgroundTaskID = app.beginBackgroundTask(withName: "Finish Export") {
            app.endBackgroundTask(self.backgroundTaskID)
            self.backgroundTaskID = .invalid
        }
        self.saveState()
        app.endBackgroundTask(backgroundTaskID)
        backgroundTaskID = .invalid
    }
}
```

## iOS 26新增：持续处理任务

### 适用场景
持续处理任务(BGContinuedProcessingTask)专门用于处理用户明确触发的长时间操作，如：
- 文件导出
- 社交媒体内容发布
- 配件固件更新

### 实现步骤
1. 在Info.plist中添加任务ID
2. 注册任务处理程序
3. 提交任务请求

```swift
import BackgroundTasks

func handleDialogConfirmation() {
    BGTaskScheduler.shared.register("com.colorfeed.wwdc25.userTask") { task in
        let task = task as! BGContinuedProcessingTask
                                                                      
        var shouldContinue = true
        task.expirationHandler = { shouldContinue = false }

        task.progress.totalUnitCount = 100
        task.progress.completedUnitCount = 0

        while shouldContinue {
            // 执行工作
            task.progress.completedUnitCount += 1
        }

        task.setTaskCompleted(success: true)
    }
}

func submitContinuedProcessingTaskRequest() {
    let request = BGContinuedProcessingTaskRequest(
        identifier: "com.colorfeed.wwdc25.userTask",
        title: "简明标题",
        subtitle: "实用且信息丰富的副标题"
    )
    request.strategy = .fail
    BGTaskScheduler.shared.submit(request)!
}
```

### 关键特性
1. **进度反馈**：必须及时汇报工作进度
2. **终止处理**：提供优雅终止任务的机制
3. **GPU支持**：在支持设备上可获取后台GPU访问权限
4. **用户控制**：用户可随时查看进度或取消任务

## 最佳实践总结

1. **明确任务类型**：区分是用户触发还是系统触发
2. **控制任务时长**：短任务优先，长任务分解
3. **优先用户价值**：后台任务应带来明显用户体验提升
4. **尊重系统限制**：适应电池、网络等条件变化
5. **测试各种场景**：包括低电量模式、弱网环境等

## 相关文档
- [后台任务官方文档](https://developer.com/documentation/BackgroundTasks)  
- [iOS和iPadOS上的长时任务处理](https://developer.com/documentation/BackgroundTasks/performing-long-running-tasks-on-ios-and-ipados)
> 此文章由AI生成，可能存在错误，如有问题，请联系[djs66256@163.com](djs66256@163.com)