---
title: 跟着视频学编程：使用 Swift 并发机制提升 App 性能
date: 2025-06-10 15:39:49
categories:
- wwdc2025
tags:
- wwdc2025
- ios
- ipados
- macos
- tvos
- visionos
- watchos
- 开发者工具
---
通过更新一个现有的示例 app，我们将向你介绍如何通过 swift 并发机制来优化 app 的用户体验。我们将从一个主 actor app 入手，然后根据需要逐步引入异步代码。我们将使用任务来优化主 actor 上运行的代码，并探索如何通过将工作转移到后台来实现代码并行运行。我们将探讨数据争用安全机制提供的功能，并讲解如何解读和修复数据争用安全错误。最后，我们将展示如何在 app 情境中充分利用结构化并发机制。
<!--more-->

![视频封面](https://devimages-cdn.apple.com/wwdc-services/images/3055294D-836B-4513-B7B0-0BC5666246B0/9949/9949_wide_250x141_2x.jpg)
[视频地址](https://developer.apple.com/cn/videos/play/wwdc2025/270/)

# 使用 Swift 并发机制提升应用性能的实践指南

## 引言
在现代应用开发中，保持主线程流畅响应至关重要。Swift 提供了一套完整的并发机制工具链，帮助开发者编写安全高效的异步代码。本文将带您通过一个贴纸制作应用的实例，学习如何运用 Swift 并发机制优化应用性能。

## 应用架构设计
我们的演示应用包含两个核心视图组件：
1. **贴纸轮播视图** - 展示带有渐变背景的贴纸
2. **贴纸网格视图** - 预览整套可导出的贴纸

核心处理逻辑由 `PhotoProcessor` 结构体实现，主要负责两个耗时的操作：
- 贴纸图像提取
- 主色调分析

## 关键技术实现

### 异步照片加载
使用 `PhotosPickerItem` 的异步方法 `loadTransferable` 从相册加载数据，并通过 SwiftUI 的 `task` 修饰符触发异步操作：

```swift
.task {
    await viewModel.loadPhoto(selectedPhoto)
}
```

### 后台线程处理
为 `PhotoProcessor` 添加适当的标记，使其能够安全地在后台线程运行：

```swift
nonisolated struct PhotoProcessor {
    @concurrent
    func process(data: Data) async -> ProcessedPhoto?
}
```

### 并行任务优化
利用 `async let` 语法同时执行贴纸提取和颜色分析操作：

```swift
async let sticker = extractSticker(from: data)
async let colors = extractColors(from: data)
```

### 数据竞争防护
通过将 `ColorExtractor` 改为局部变量，确保每个任务都有独立的实例，从而消除并行访问的内存风险：

```swift
private func extractColors(from data: Data) -> PhotoColorScheme? {
    let colorExtractor = ColorExtractor() // 每个任务独立实例
    return colorExtractor.extractColors(from: data)
}
```

### 结构化并发
使用 `TaskGroup` 批量处理所有照片，提高整体效率：

```swift
await withTaskGroup { group in
    for item in selection {
        group.addTask { /* 处理单个照片 */ }
    }
}
```

## 性能优化成果
通过以上技术实现，我们取得了显著的性能提升：
1. 主线程保持流畅响应
2. 处理耗时降低50%以上
3. 完全消除了数据竞争风险
4. 实现了高效的批量导出功能

## 总结与建议
Swift的并发机制为应用性能优化提供了强大而安全的工具。从简单的异步操作到复杂的结构化并发，开发者可以逐步将这些技术应用到实际项目中。建议从项目中识别出可以异步执行的操作开始，逐步引入这些技术。

## 相关视频
- [探索 SwiftUI 中的并发机制](https://developer.apple.com/videos/play/wwdc2025/266)
- [采用 Swift 并发](https://developer.apple.com/videos/play/wwdc2025/268)
- [使用 Instruments 分析挂起](https://developer.apple.com/videos/play/wwdc2023/10248)
- [超越结构化并发的基础](https://developer.apple.com/videos/play/wwdc2023/10170)

## 文档
- [Swift 迁移指南](https://www.swift.org/migration/documentation/migrationguide/)
> 此文章由AI生成，可能存在错误，如有问题，请联系[djs66256@163.com](djs66256@163.com)