---
title: 安全地混合使用 C、C ++ 和 Swift
date: 2025-06-10 15:29:50
categories:
- wwdc2025
tags:
- wwdc2025
- ios
- ipados
- macos
- tvos
- visionos
- watchos
- swift
---
了解如何混合使用 c、c++ 和 swift，同时提高 app 的安全性。我们将介绍如何在 swift 代码中找到不安全的 c 和 c++ api 调用位置、如何更安全地调用这些 api，以及如何使 app 中的现有 c 和 c++ 代码默认处于更安全的状态。
<!--more-->

![视频封面](https://devimages-cdn.apple.com/wwdc-services/images/3055294D-836B-4513-B7B0-0BC5666246B0/10033/10033_wide_250x141_2x.jpg)
[视频地址](https://developer.apple.com/cn/videos/play/wwdc2025/311/)

# 安全混合编程：如何让 Swift 与 C/C++ 安全共处

## 引言

在现代应用开发中，混合使用 Swift 与 C/C++ 代码的情况十分常见。Swift 以其内存安全性著称，而 C/C++ 则因其高性能和不安全特性成为潜在的安全隐患。如何让这两种语言安全共存？本文将介绍 Apple 在 Swift 6.2 中引入的新技术，帮助你识别和消除跨语言调用的安全隐患。

## 问题根源：指针的不安全特性

C/C++ 中的原始指针缺乏安全防护机制，这导致了两大核心问题：
1. **边界检查缺失**：无法防止数组越界访问
2. **生命周期管理缺失**：可能导致"释放后使用"等严重漏洞

在 Swift 中调用这些不安全函数时，编译器会将其导入为`UnsafeMutablePointer`等类型，但开发者往往难以察觉这些隐式的不安全操作。

## 定位安全隐患：严格内存安全模式

Swift 6.2 引入的"严格内存安全模式"(Strict Memory Safety)能有效识别这些安全隐患：

```swift
// 开启严格模式后会标记不安全操作
var imageData = [UInt8](repeating: 0, count: imageDataSize)
filterImage(&imageData, imageData.count) // 警告：不安全操作
```

在 Xcode 项目中开启该模式后，所有涉及不安全指针的操作都会被明确标记，帮助开发者发现潜在风险。

## 安全调用 C/C++ API 的解决方案

### 1. 处理指针参数函数

对于接受原始指针的 C 函数，可以使用`__counted_by`注释明确指针与数组大小的关系：

```c
void invertImage(uint8_t *__counted_by(imageSize) imagePtr __noescape, size_t imageSize);
```

这种注释让 Swift 编译器能将指针安全地转换为`MutableSpan`类型，自动处理边界检查。

### 2. 处理 C++ Span 类型

C++的`std::span`虽然比原始指针更安全，但仍需`__noescape`注释来确保生命周期安全：

```cpp
void applyGrayscale(CxxSpanOfByte imageView __noescape);
```

### 3. 处理返回指针的函数

对于返回视图的函数，使用`__lifetimebound`注释声明返回值的生命周期依赖：

```cpp
CxxSpanOfByte scanImageRow(CxxSpanOfByte imageView __lifetimebound, size_t width, size_t rowIndex);
```

## 安全导入自定义 C++ 类型

不同类型的 C++ 结构体需要不同的注释策略：

1. **视图类型**：使用`SWIFT_NONESCAPABLE`标记
2. **引用计数类型**：配合保留/释放函数使用`SWIFT_SHARED_REFERENCE`

```cpp
struct ImageBuffer SWIFT_SHARED_REFERENCE(retain_image_buffer, release_image_buffer);
```

## 提升 C/C++ 代码安全性的额外措施

1. 开启 C++标准库的边界检查
2. 强制使用 C++ Span 替代原始指针
3. 对 C 语言使用边界安全扩展(`__counted_by`)

## 结论

实现 Swift 与 C/C++ 安全互操作的关键步骤：
1. 在 Swift 项目中启用严格内存安全模式
2. 为所有 C/C++ API 添加适当的安全注释
3. 启用 C/C++ 端的边界安全检查功能

通过这些措施，你可以在保留 C/C++ 高性能优势的同时，享受 Swift 的内存安全保障。

## 相关视频

- [优化 Swift 代码的内存使用和性能](https://developer.apple.com/videos/play/wwdc2025/312)

## 文档

- [-fbounds-safety: Enforcing bounds safety for C](https://clang.llvm.org/docs/BoundsSafety.html)
- [Safely Mixing Swift and C++](https://www.swift.org/documentation/cxx-interop/safe-interop/)
> 此文章由AI生成，可能存在错误，如有问题，请联系[djs66256@163.com](djs66256@163.com)