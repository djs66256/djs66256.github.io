<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://djs66256.github.io">
  <title>C方法的调用参数与ARM汇编 | 苍耳的技术博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在平时开发和调试中，经常遇到C调用栈和汇编，所以这里来统一的了解下这部分内容，本章需要一定的汇编基础才能更好的理解。">
<meta property="og:type" content="article">
<meta property="og:title" content="C方法的调用参数与ARM汇编">
<meta property="og:url" content="http://djs66256.github.io/2018/01/11/2018-01-11-C%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E5%8F%82%E6%95%B0%E4%B8%8EARM%E6%B1%87%E7%BC%96/index.html">
<meta property="og:site_name" content="苍耳的技术博客">
<meta property="og:description" content="在平时开发和调试中，经常遇到C调用栈和汇编，所以这里来统一的了解下这部分内容，本章需要一定的汇编基础才能更好的理解。">
<meta property="og:locale">
<meta property="og:image" content="http://djs66256.github.io/images/2018/asm/registers.png">
<meta property="og:image" content="http://djs66256.github.io/images/2018/asm/stack_frame.png">
<meta property="article:published_time" content="2018-01-11T12:43:57.000Z">
<meta property="article:modified_time" content="2025-06-08T16:17:44.877Z">
<meta property="article:author" content="苍耳">
<meta property="article:tag" content="C">
<meta property="article:tag" content="ARM">
<meta property="article:tag" content="ASM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://djs66256.github.io/images/2018/asm/registers.png">
  
    <link rel="alternative" href="/atom.xml" title="苍耳的技术博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" type="text/css" href="/./main.234bc0.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  

  
<script>
var _hmt = _hmt || [];
(function() {
	if (location.hostname != "localhost") {
	var hm = document.createElement("script");
	hm.src = "https://hm.baidu.com/hm.js?d75fe53e2fff778b91995ef2cf821fcd";
	var s = document.getElementsByTagName("script")[0];
	s.parentNode.insertBefore(hm, s);
  }
})();
</script>
<script>
  (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();
  </script>


<meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="/images/avatar.png" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">苍耳</a></h1>
		</hgroup>
		
		<p class="header-subtitle">无悔的人生</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/categories/iOS/">iOS</a></li>
	        
				<li><a href="/categories/wwdc2025/">WWDC2025</a></li>
	        
				<li><a href="/2012/08/05/my-project/">我的项目</a></li>
	        
				<li><a href="/2012/07/17/project/">开源项目</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
            
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/djs66256" title="github"><i class="icon-github"></i></a>
		        
					<a class="rss" target="_blank" href="/atom.xml" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="jianshu" target="_blank" href="http://www.jianshu.com/u/711179b62eca" title="jianshu"><i class="icon-jianshu"></i></a>
		        
					<a class="mail" target="_blank" href="mailto:djs66256@163.com" title="mail"><i class="icon-mail"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="/images/avatar.png" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">苍耳</h1>
			</hgroup>
			
			<p class="header-subtitle"><i class="icon icon-quo-left"></i>无悔的人生<i class="icon icon-quo-right"></i></p>
			
			
			
				
			
				
			
				
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/djs66256" title="github"><i class="icon-github"></i></a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="jianshu" target="_blank" href="http://www.jianshu.com/u/711179b62eca" title="jianshu"><i class="icon-jianshu"></i></a>
			        
						<a class="mail" target="_blank" href="mailto:djs66256@163.com" title="mail"><i class="icon-mail"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 70%">
				
				
					<li style="width: 20%"><a href="/">主页</a></li>
		        
					<li style="width: 20%"><a href="/categories/iOS/">iOS</a></li>
		        
					<li style="width: 20%"><a href="/categories/wwdc2025/">WWDC2025</a></li>
		        
					<li style="width: 20%"><a href="/2012/08/05/my-project/">我的项目</a></li>
		        
					<li style="width: 20%"><a href="/2012/07/17/project/">开源项目</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            <article id="post-2018-01-11-C方法的调用参数与ARM汇编" class="article article-type-post " itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      C方法的调用参数与ARM汇编
    </h1>
  

        
        <a href="/2018/01/11/2018-01-11-C%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E5%8F%82%E6%95%B0%E4%B8%8EARM%E6%B1%87%E7%BC%96/" class="archive-article-date">
  	<time datetime="2018-01-11T12:43:57.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-01-11</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在平时开发和调试中，经常遇到C调用栈和汇编，所以这里来统一的了解下这部分内容，本章需要一定的汇编基础才能更好的理解。</p>
<span id="more"></span>
<h2 id="函数签名"><a href="#函数签名" class="headerlink" title="函数签名"></a>函数签名</h2><p>在JavaScript中，我们定义函数和调用函数都是相当自由的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">func</span>(<span class="params">a, b, c</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a, b, c)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">func</span>(<span class="number">1</span>)</span><br><span class="line"><span class="title function_">func</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)</span><br></pre></td></tr></table></figure>
<p>这样做完全没有问题。但是在C语言中，方法调用却是非常严格的，如果参数类型或者个数不对，就会直接编译失败（隐式转换除外）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">arg1_func</span><span class="params">(<span class="type">int</span> a)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">arg2_func</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">arg1_func(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">arg2_func(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>以上C语言将会直接编译不通过，原因之后再说。这里我们把<code>int(*)(int)</code>称为这个函数的<code>函数签名</code>。</p>
<p>为什么我们要了解<code>函数签名</code>呢？由于C方法的参数传递是和函数签名相关的，而且是编译期就需要确定的。他决定了参数是如何传递给具体方法，并且返回参数是如何返回的。</p>
<p>那么接下来就让我们来了解C语言的参数传递方式。由于不同架构平台拥有不同的处理方式，但大同小异，这里我们就用<code>AArch64</code>架构来做介绍。</p>
<h2 id="Registers"><a href="#Registers" class="headerlink" title="Registers"></a>Registers</h2><p>在了解底层之前，我们需要一点ARM的预备知识，这里做一个简单的介绍，具体ARM汇编可以参考官方文档<a target="_blank" rel="noopener" href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0801g/DUI0801G_armasm_user_guide.pdf"><strong>armasm_user_guide</strong></a>和<a target="_blank" rel="noopener" href="http://infocenter.arm.com/help/topic/com.arm.doc.den0024a/DEN0024A_v8_architecture_PG.pdf"><strong>ABI</strong></a>。</p>
<h5 id="ARM-ASM-4-1节"><a href="#ARM-ASM-4-1节" class="headerlink" title="ARM_ASM (4.1节)"></a>ARM_ASM (4.1节)</h5><p>In AArch64 state, the following registers are available:</p>
<ul>
<li>Thirty-one 64-bit general-purpose registers X0-X30, the bottom halves of which are accessible as<br>W0-W30.</li>
<li>Four stack pointer registers SP_EL0, SP_EL1, SP_EL2, SP_EL3.</li>
<li>Three exception link registers ELR_EL1, ELR_EL2, ELR_EL3.</li>
<li>Three saved program status registers SPSR_EL1, SPSR_EL2, SPSR_EL3.</li>
<li>One program counter.</li>
</ul>
<h5 id="ABI-9-1节"><a href="#ABI-9-1节" class="headerlink" title="ABI (9.1节)"></a>ABI (9.1节)</h5><p>For the purposes of function calls, the general-purpose registers are divided into four groups:</p>
<ol>
<li><p>Argument registers (X0-X7)</p>
<p> These are used to pass parameters to a function and to return a result. They can be used as scratch registers or as caller-saved register variables that can hold intermediate values within a function, between calls to other functions. The fact that 8 registers are available for passing parameters reduces the need to spill parameters to the stack when compared with AArch32.</p>
</li>
<li><p>Caller-saved temporary registers (X9-X15)</p>
<p> If the caller requires the values in any of these registers to be preserved across a call to another function, the caller must save the affected registers in its own stack frame. They can be modified by the called subroutine without the need to save and restore them before returning to the caller.</p>
</li>
<li><p>Callee-saved registers (X19-X29)</p>
<p> These registers are saved in the callee frame. They can be modified by the called subroutine as long as they are saved and restored before returning.</p>
</li>
<li><p>Registers with a special purpose (X8, X16-X18, X29, X30)</p>
<ul>
<li>X8 is the indirect result register. This is used to pass the address location of an indirect result, for example, where a function returns a large structure.</li>
<li>X16 and X17 are IP0 and IP1, intra-procedure-call temporary registers. These can be used by call veneers and similar code, or as temporary registers for intermediate values between subroutine calls. They are corruptible by a function. Veneers are small pieces of code which are automatically inserted by the linker, for example when the branch target is out of range of the branch instruction.</li>
<li>X18 is the platform register and is reserved for the use of platform ABIs. This is an additional temporary register on platforms that don’t assign a special meaning to it.</li>
<li>X29 is the frame pointer register (FP).</li>
<li>X30 is the link register (LR).</li>
</ul>
</li>
</ol>
<p>根据官方文档，这里我们需要知道的是X0-X30个通用寄存器，D0-D31个浮点寄存器，堆栈寄存器SP，和独立不可直接操作的PC寄存器。</p>
<p>其中通用寄存器在C语言的ABI定义中，X29作为栈帧FP，X30作为函数返回地址LR，X0-X7作为参数寄存器，X8为<code>Indirect result location</code>（和返回值相关），X9-X15为临时寄存器。其他的寄存器和目前我们的内容没有太大的关系，所以不做介绍了。这里有个官方的简要图：</p>
<p><img src="/images/2018/asm/registers.png" alt=""></p>
<p>在阅读以下内容需要明确上述的几个寄存器，特别是<code>LR=X30</code>，<code>FP=X29</code>，其中W0和X0代表同一个寄存器，只是W是32位，X是64位。</p>
<p>需要了解的存取指令是LDR（load），STR（store），其他存取指令都是以这两个为基础。相关运算可见<code>ABI 6.3.4节</code>，这里介绍下下面会遇到的运算：</p>
<table>
<thead>
<tr>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>LDR X0, [X1, #8]</code></td>
<td>Load from address X1 + 8</td>
</tr>
<tr>
<td><code>LDR X0, [X1, #8]!</code></td>
<td>Pre-index: Update X1 first (to X1 + #8), then load from the new address</td>
</tr>
<tr>
<td><code>LDR X0, [X1], #8</code></td>
<td>Post-index: Load from the unmodified address in X1 first, then update X1 (to X1 + #8)</td>
</tr>
</tbody>
</table>
<h2 id="Stack-Frame"><a href="#Stack-Frame" class="headerlink" title="Stack Frame"></a>Stack Frame</h2><p>在C语言调用过程中，<code>SP</code>和<code>LR</code>是成对出现的，他们代表了一个函数的栈区域，也称为<code>栈帧</code>。</p>
<p>一个栈帧的大概结构如下：</p>
<p><img src="/images/2018/asm/stack_frame.png" alt=""></p>
<p>这个结构对我们来说非常重要，也是本次我们讨论的重点。</p>
<h2 id="少参数调用"><a href="#少参数调用" class="headerlink" title="少参数调用"></a>少参数调用</h2><p>对于一个函数的调用，入参会放入X0-X7中，返回参数会放在X0中返回，那么我们就来分析下一个简单的例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">lessArg</span><span class="params">(<span class="type">int</span> arg1, <span class="type">char</span> *arg2)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用前：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">caller:</span></span><br><span class="line">    <span class="number">0x100791c6c</span> &lt;+<span class="number">20</span>&gt;:  <span class="keyword">mov</span>    <span class="built_in">w9</span>, <span class="number">#0x0</span></span><br><span class="line">    <span class="number">0x100791c70</span> &lt;+<span class="number">24</span>&gt;:  stur   <span class="built_in">w9</span>, [<span class="built_in">x29</span>, #-<span class="number">0x14</span>]</span><br><span class="line">    <span class="number">0x100791c74</span> &lt;+<span class="number">28</span>&gt;:  stur   <span class="built_in">w0</span>, [<span class="built_in">x29</span>, #-<span class="number">0x18</span>]</span><br><span class="line">    <span class="number">0x100791c78</span> &lt;+<span class="number">32</span>&gt;:  <span class="keyword">str</span>    <span class="built_in">x1</span>, [<span class="built_in">x8</span>, <span class="number">#0xa0</span>]</span><br><span class="line">    <span class="number">0x100791c7c</span> &lt;+<span class="number">36</span>&gt;:  <span class="keyword">mov</span>    <span class="built_in">x1</span>, <span class="number">#0x0</span>                 <span class="comment">; // 第二个参数 arg2 = 0</span></span><br><span class="line">    <span class="number">0x100791c80</span> &lt;+<span class="number">40</span>&gt;:  <span class="keyword">mov</span>    <span class="built_in">x0</span>, <span class="built_in">x9</span>                   <span class="comment">; // 第一个参数 arg1 = 0</span></span><br><span class="line">    <span class="number">0x100791c84</span> &lt;+<span class="number">44</span>&gt;:  <span class="keyword">str</span>    <span class="built_in">x1</span>, [<span class="built_in">sp</span>, <span class="number">#0x88</span>]</span><br><span class="line">    <span class="number">0x100791c88</span> &lt;+<span class="number">48</span>&gt;:  <span class="keyword">str</span>    <span class="built_in">x8</span>, [<span class="built_in">sp</span>, <span class="number">#0x80</span>]</span><br><span class="line">    <span class="number">0x100791c8c</span> &lt;+<span class="number">52</span>&gt;:  <span class="keyword">str</span>    <span class="built_in">w9</span>, [<span class="built_in">sp</span>, <span class="number">#0x7c</span>]</span><br><span class="line">    <span class="number">0x100791c90</span> &lt;+<span class="number">56</span>&gt;:  <span class="keyword">bl</span>     <span class="number">0x100791a60</span>               <span class="comment">; CALL &#x27;lessArg&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">cfunction</span>`lessArg:</span><br><span class="line">    <span class="number">0x104491a98</span> &lt;+<span class="number">0</span>&gt;:  <span class="keyword">sub</span>    <span class="built_in">sp</span>, <span class="built_in">sp</span>, <span class="number">#0x10</span>             <span class="comment">; 由于栈是向下增长的，所以 SP = SP - 0x10</span></span><br><span class="line">    <span class="number">0x104491a9c</span> &lt;+<span class="number">4</span>&gt;:  <span class="keyword">mov</span>    <span class="built_in">w8</span>, <span class="number">#0x0</span></span><br><span class="line">    <span class="number">0x104491aa0</span> &lt;+<span class="number">8</span>&gt;:  <span class="keyword">str</span>    <span class="built_in">w0</span>, [<span class="built_in">sp</span>, <span class="number">#0xc</span>]</span><br><span class="line">    <span class="number">0x104491aa4</span> &lt;+<span class="number">12</span>&gt;: <span class="keyword">str</span>    <span class="built_in">x1</span>, [<span class="built_in">sp</span>]</span><br><span class="line">    <span class="number">0x104491aa8</span> &lt;+<span class="number">16</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">x0</span>, <span class="built_in">x8</span>                    <span class="comment">; 返回值 X0 = 0</span></span><br><span class="line">    <span class="number">0x104491aac</span> &lt;+<span class="number">20</span>&gt;: <span class="keyword">add</span>    <span class="built_in">sp</span>, <span class="built_in">sp</span>, <span class="number">#0x10</span>             <span class="comment">; 销毁栈</span></span><br><span class="line">    <span class="number">0x104491ab0</span> &lt;+<span class="number">24</span>&gt;: ret    </span><br></pre></td></tr></table></figure>
<p>由以上结果看的确按照ABI所描述的，在&lt;=8个参数的时候，参数是放在寄存器中传递。</p>
<h2 id="多参数调用"><a href="#多参数调用" class="headerlink" title="多参数调用"></a>多参数调用</h2><p>那么如果参数超过8个呢？据ABI描述是通过堆栈的形式来传递，我们来看下结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">moreArg</span><span class="params">(<span class="type">int</span> arg1, <span class="type">int</span> arg2, <span class="type">int</span> arg3, <span class="type">int</span> arg4, <span class="type">int</span> arg5, <span class="type">int</span> arg6, <span class="type">int</span> arg7, <span class="type">int</span> arg8, <span class="type">int</span> arg9, <span class="type">int</span> arg10, <span class="type">int</span> arg11, <span class="type">int</span> arg12, <span class="type">int</span> arg13, <span class="type">char</span> *arg14)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">caller:</span></span><br><span class="line">    <span class="number">0x100791c9c</span> &lt;+<span class="number">68</span>&gt;:  <span class="keyword">mov</span>    <span class="built_in">x1</span>, <span class="built_in">sp</span>                   <span class="comment">; x1 = SP</span></span><br><span class="line">    <span class="number">0x100791ca0</span> &lt;+<span class="number">72</span>&gt;:  <span class="keyword">ldr</span>    <span class="built_in">x30</span>, [<span class="built_in">sp</span>, <span class="number">#0x88</span>]</span><br><span class="line">    <span class="number">0x100791ca4</span> &lt;+<span class="number">76</span>&gt;:  <span class="keyword">str</span>    <span class="built_in">x30</span>, [<span class="built_in">x1</span>, <span class="number">#0x18</span>]</span><br><span class="line">    <span class="number">0x100791ca8</span> &lt;+<span class="number">80</span>&gt;:  <span class="keyword">orr</span>    <span class="built_in">w9</span>, wzr, <span class="number">#0xc</span>  </span><br><span class="line">    <span class="number">0x100791cac</span> &lt;+<span class="number">84</span>&gt;:  <span class="keyword">str</span>    <span class="built_in">w9</span>, [<span class="built_in">x1</span>, <span class="number">#0x10</span>]          <span class="comment">; SP+0x10 = arg13</span></span><br><span class="line">    <span class="number">0x100791cb0</span> &lt;+<span class="number">88</span>&gt;:  <span class="keyword">mov</span>    <span class="built_in">w9</span>, <span class="number">#0xb</span>      </span><br><span class="line">    <span class="number">0x100791cb4</span> &lt;+<span class="number">92</span>&gt;:  <span class="keyword">str</span>    <span class="built_in">w9</span>, [<span class="built_in">x1</span>, <span class="number">#0xc</span>]           <span class="comment">; SP+0xc = arg12</span></span><br><span class="line">    <span class="number">0x100791cb8</span> &lt;+<span class="number">96</span>&gt;:  <span class="keyword">mov</span>    <span class="built_in">w9</span>, <span class="number">#0xa</span>      </span><br><span class="line">    <span class="number">0x100791cbc</span> &lt;+<span class="number">100</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w9</span>, [<span class="built_in">x1</span>, <span class="number">#0x8</span>]           <span class="comment">; SP+0x8 = arg11</span></span><br><span class="line">    <span class="number">0x100791cc0</span> &lt;+<span class="number">104</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">w9</span>, <span class="number">#0x9</span></span><br><span class="line">    <span class="number">0x100791cc4</span> &lt;+<span class="number">108</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w9</span>, [<span class="built_in">x1</span>, <span class="number">#0x4</span>]           <span class="comment">; SP+0x4 = arg10</span></span><br><span class="line">    <span class="number">0x100791cc8</span> &lt;+<span class="number">112</span>&gt;: <span class="keyword">orr</span>    <span class="built_in">w9</span>, wzr, <span class="number">#0x8</span>            </span><br><span class="line">    <span class="number">0x100791ccc</span> &lt;+<span class="number">116</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w9</span>, [<span class="built_in">x1</span>]                 <span class="comment">; SP = arg9</span></span><br><span class="line">    <span class="number">0x100791cd4</span> &lt;+<span class="number">124</span>&gt;: <span class="keyword">orr</span>    <span class="built_in">w2</span>, wzr, <span class="number">#0x2</span>            <span class="comment">; w2 = arg3</span></span><br><span class="line">    <span class="number">0x100791cd8</span> &lt;+<span class="number">128</span>&gt;: <span class="keyword">orr</span>    <span class="built_in">w3</span>, wzr, <span class="number">#0x3</span>            <span class="comment">; w3 = arg4</span></span><br><span class="line">    <span class="number">0x100791cdc</span> &lt;+<span class="number">132</span>&gt;: <span class="keyword">orr</span>    <span class="built_in">w4</span>, wzr, <span class="number">#0x4</span>            <span class="comment">; w4 = arg5</span></span><br><span class="line">    <span class="number">0x100791ce0</span> &lt;+<span class="number">136</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">w5</span>, <span class="number">#0x5</span>                 <span class="comment">; w5 = arg6</span></span><br><span class="line">    <span class="number">0x100791ce4</span> &lt;+<span class="number">140</span>&gt;: <span class="keyword">orr</span>    <span class="built_in">w6</span>, wzr, <span class="number">#0x6</span>            <span class="comment">; w6 = arg7</span></span><br><span class="line">    <span class="number">0x100791ce8</span> &lt;+<span class="number">144</span>&gt;: <span class="keyword">orr</span>    <span class="built_in">w7</span>, wzr, <span class="number">#0x7</span>            <span class="comment">; w7 = arg8</span></span><br><span class="line">    <span class="number">0x100791cec</span> &lt;+<span class="number">148</span>&gt;: <span class="keyword">ldr</span>    <span class="built_in">w10</span>, [<span class="built_in">sp</span>, <span class="number">#0x7c</span>]</span><br><span class="line">    <span class="number">0x100791cf0</span> &lt;+<span class="number">152</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w0</span>, [<span class="built_in">sp</span>, <span class="number">#0x78</span>]</span><br><span class="line">    <span class="number">0x100791cf4</span> &lt;+<span class="number">156</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">x0</span>, <span class="built_in">x10</span>                  <span class="comment">; w0 = arg1</span></span><br><span class="line">    <span class="number">0x100791cd0</span> &lt;+<span class="number">120</span>&gt;: <span class="keyword">orr</span>    <span class="built_in">w9</span>, wzr, <span class="number">#0x1</span></span><br><span class="line">    <span class="number">0x100791cf8</span> &lt;+<span class="number">160</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">x1</span>, <span class="built_in">x9</span>                   <span class="comment">; w1 = arg2</span></span><br><span class="line">    <span class="number">0x100791cfc</span> &lt;+<span class="number">164</span>&gt;: <span class="keyword">str</span>    <span class="built_in">x8</span>, [<span class="built_in">sp</span>, <span class="number">#0x70</span>]</span><br><span class="line">    <span class="number">0x100791d00</span> &lt;+<span class="number">168</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w9</span>, [<span class="built_in">sp</span>, <span class="number">#0x6c</span>]</span><br><span class="line">    <span class="number">0x100791d04</span> &lt;+<span class="number">172</span>&gt;: <span class="keyword">bl</span>     <span class="number">0x100791a7c</span>               <span class="comment">; moreArg at main.mm:16</span></span><br></pre></td></tr></table></figure>
<p>从上面可以看出来，arg9以上的入参被存在了<code>SP ~ (SP+0x10)</code>的位置，也就是当前栈的栈底，下一层栈帧的栈顶。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">cfunction</span>`moreArg:</span><br><span class="line">    <span class="number">0x104491ab4</span> &lt;+<span class="number">0</span>&gt;:  <span class="keyword">sub</span>    <span class="built_in">sp</span>, <span class="built_in">sp</span>, <span class="number">#0x40</span>             <span class="comment">; 申请栈空间，这里我们将原来的sp记作&#x27;SP0&#x27;</span></span><br><span class="line">                                                        <span class="comment">; 那么 SP = SP0 - 0x40</span></span><br><span class="line">    <span class="number">0x104491ab8</span> &lt;+<span class="number">4</span>&gt;:  <span class="keyword">ldr</span>    <span class="built_in">x8</span>, [<span class="built_in">sp</span>, <span class="number">#0x58</span>]           </span><br><span class="line">    <span class="number">0x104491abc</span> &lt;+<span class="number">8</span>&gt;:  <span class="keyword">ldr</span>    <span class="built_in">w9</span>, [<span class="built_in">sp</span>, <span class="number">#0x50</span>]           <span class="comment">; w9 = SP + 0x50 = SP0 - 0x40 + 0x50 = SP0 + 0x10</span></span><br><span class="line">                                                        <span class="comment">; 也就是w13 = arg13</span></span><br><span class="line">                                                        <span class="comment">; 按照这样的推导，下面依次为arg9 ~ arg12</span></span><br><span class="line">    <span class="number">0x104491ac0</span> &lt;+<span class="number">12</span>&gt;: <span class="keyword">ldr</span>    <span class="built_in">w10</span>, [<span class="built_in">sp</span>, <span class="number">#0x4c</span>]</span><br><span class="line">    <span class="number">0x104491ac4</span> &lt;+<span class="number">16</span>&gt;: <span class="keyword">ldr</span>    <span class="built_in">w11</span>, [<span class="built_in">sp</span>, <span class="number">#0x48</span>]</span><br><span class="line">    <span class="number">0x104491ac8</span> &lt;+<span class="number">20</span>&gt;: <span class="keyword">ldr</span>    <span class="built_in">w12</span>, [<span class="built_in">sp</span>, <span class="number">#0x44</span>]</span><br><span class="line">    <span class="number">0x104491acc</span> &lt;+<span class="number">24</span>&gt;: <span class="keyword">ldr</span>    <span class="built_in">w13</span>, [<span class="built_in">sp</span>, <span class="number">#0x40</span>]          <span class="comment">; w13 = SP + 0x40 = SP0 - 0x40 + 0x40 = SP0</span></span><br><span class="line">                                                        <span class="comment">; 也就是w13 = arg9</span></span><br><span class="line">    <span class="number">0x104491ad0</span> &lt;+<span class="number">28</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">w14</span>, <span class="number">#0x0</span></span><br><span class="line">    <span class="number">0x104491ad4</span> &lt;+<span class="number">32</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w0</span>, [<span class="built_in">sp</span>, <span class="number">#0x3c</span>]</span><br><span class="line">    <span class="number">0x104491ad8</span> &lt;+<span class="number">36</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w1</span>, [<span class="built_in">sp</span>, <span class="number">#0x38</span>]</span><br><span class="line">    <span class="number">0x104491adc</span> &lt;+<span class="number">40</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w2</span>, [<span class="built_in">sp</span>, <span class="number">#0x34</span>]</span><br><span class="line">    <span class="number">0x104491ae0</span> &lt;+<span class="number">44</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w3</span>, [<span class="built_in">sp</span>, <span class="number">#0x30</span>]</span><br><span class="line">    <span class="number">0x104491ae4</span> &lt;+<span class="number">48</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w4</span>, [<span class="built_in">sp</span>, <span class="number">#0x2c</span>]</span><br><span class="line">    <span class="number">0x104491ae8</span> &lt;+<span class="number">52</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w5</span>, [<span class="built_in">sp</span>, <span class="number">#0x28</span>]</span><br><span class="line">    <span class="number">0x104491aec</span> &lt;+<span class="number">56</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w6</span>, [<span class="built_in">sp</span>, <span class="number">#0x24</span>]</span><br><span class="line">    <span class="number">0x104491af0</span> &lt;+<span class="number">60</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w7</span>, [<span class="built_in">sp</span>, <span class="number">#0x20</span>]</span><br><span class="line">    <span class="number">0x104491af4</span> &lt;+<span class="number">64</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w13</span>, [<span class="built_in">sp</span>, <span class="number">#0x1c</span>]</span><br><span class="line">    <span class="number">0x104491af8</span> &lt;+<span class="number">68</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w12</span>, [<span class="built_in">sp</span>, <span class="number">#0x18</span>]</span><br><span class="line">    <span class="number">0x104491afc</span> &lt;+<span class="number">72</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w11</span>, [<span class="built_in">sp</span>, <span class="number">#0x14</span>]</span><br><span class="line">    <span class="number">0x104491b00</span> &lt;+<span class="number">76</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w10</span>, [<span class="built_in">sp</span>, <span class="number">#0x10</span>]</span><br><span class="line">    <span class="number">0x104491b04</span> &lt;+<span class="number">80</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w9</span>, [<span class="built_in">sp</span>, <span class="number">#0xc</span>]</span><br><span class="line">    <span class="number">0x104491b08</span> &lt;+<span class="number">84</span>&gt;: <span class="keyword">str</span>    <span class="built_in">x8</span>, [<span class="built_in">sp</span>]</span><br><span class="line">    <span class="number">0x104491b0c</span> &lt;+<span class="number">88</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">x0</span>, <span class="built_in">x14</span></span><br><span class="line">    <span class="number">0x104491b10</span> &lt;+<span class="number">92</span>&gt;: <span class="keyword">add</span>    <span class="built_in">sp</span>, <span class="built_in">sp</span>, <span class="number">#0x40</span>             <span class="comment">; =0x40 </span></span><br><span class="line">    <span class="number">0x104491b14</span> &lt;+<span class="number">96</span>&gt;: ret    </span><br></pre></td></tr></table></figure>
<p>由此可见，大于8个的参数会被放入栈中<code>SP ~ (SP + count - 8)</code>，和预期的一样。</p>
<h2 id="struct参数及返回"><a href="#struct参数及返回" class="headerlink" title="struct参数及返回"></a>struct参数及返回</h2><p>上面说了基本类型的传递情况，在C语言中，还有一类不定长数据类型可以直接传递，那就是struct。那么我们来看看struct参数是怎么传递的。</p>
<h4 id="小struct"><a href="#小struct" class="headerlink" title="小struct"></a>小struct</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SmallStruct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> arg1;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> SmallStruct <span class="title function_">smallStructFunc</span><span class="params">(<span class="type">int</span> arg1, <span class="keyword">struct</span> SmallStruct arg2)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">SmallStruct</span> <span class="title">s</span> =</span> arg2;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">caller:</span></span><br><span class="line">    <span class="number">0x100791d24</span> &lt;+<span class="number">204</span>&gt;: ldur   <span class="built_in">w9</span>, [<span class="built_in">x29</span>, #-<span class="number">0x30</span>]</span><br><span class="line">    <span class="number">0x100791d28</span> &lt;+<span class="number">208</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">x1</span>, <span class="built_in">x9</span>                    <span class="comment">; x1 = arg2 !</span></span><br><span class="line">                                                         <span class="comment">; 这里struct内容直接赋值给了x1，因为x1的容量完全够用！</span></span><br><span class="line">    <span class="number">0x100791d2c</span> &lt;+<span class="number">212</span>&gt;: <span class="keyword">ldr</span>    <span class="built_in">w9</span>, [<span class="built_in">sp</span>, <span class="number">#0x7c</span>]</span><br><span class="line">    <span class="number">0x100791d30</span> &lt;+<span class="number">216</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w0</span>, [<span class="built_in">sp</span>, <span class="number">#0x64</span>]           <span class="comment">; w0 = arg1</span></span><br><span class="line">    <span class="number">0x100791d34</span> &lt;+<span class="number">220</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">x0</span>, <span class="built_in">x9</span></span><br><span class="line">    <span class="number">0x100791d38</span> &lt;+<span class="number">224</span>&gt;: <span class="keyword">bl</span>     <span class="number">0x100791b04</span>               <span class="comment">; smallStructFunc at main.mm:32</span></span><br></pre></td></tr></table></figure>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">cfunction</span>`smallStructFunc:</span><br><span class="line">    <span class="number">0x1003b5b04</span> &lt;+<span class="number">0</span>&gt;:  <span class="keyword">sub</span>    <span class="built_in">sp</span>, <span class="built_in">sp</span>, <span class="number">#0x20</span>             <span class="comment">; =0x20 </span></span><br><span class="line">    <span class="number">0x1003b5b08</span> &lt;+<span class="number">4</span>&gt;:  <span class="keyword">mov</span>    <span class="built_in">x8</span>, <span class="built_in">x1</span>                    <span class="comment">; x8 = arg2</span></span><br><span class="line">    <span class="number">0x1003b5b0c</span> &lt;+<span class="number">8</span>&gt;:  <span class="keyword">str</span>    <span class="built_in">w8</span>, [<span class="built_in">sp</span>, <span class="number">#0x10</span>]</span><br><span class="line">    <span class="number">0x1003b5b10</span> &lt;+<span class="number">12</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w0</span>, [<span class="built_in">sp</span>, <span class="number">#0xc</span>]</span><br><span class="line">    <span class="number">0x1003b5b14</span> &lt;+<span class="number">16</span>&gt;: <span class="keyword">ldr</span>    <span class="built_in">w8</span>, [<span class="built_in">sp</span>, <span class="number">#0x10</span>]</span><br><span class="line">    <span class="number">0x1003b5b18</span> &lt;+<span class="number">20</span>&gt;: <span class="keyword">str</span>    <span class="built_in">w8</span>, [<span class="built_in">sp</span>, <span class="number">#0x18</span>]</span><br><span class="line">    <span class="number">0x1003b5b1c</span> &lt;+<span class="number">24</span>&gt;: <span class="keyword">ldr</span>    <span class="built_in">w8</span>, [<span class="built_in">sp</span>, <span class="number">#0x18</span>]</span><br><span class="line">    <span class="number">0x1003b5b20</span> &lt;+<span class="number">28</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">x0</span>, <span class="built_in">x8</span>                    <span class="comment">; x0 = x8 = arg2</span></span><br><span class="line">                                                        <span class="comment">; 这里直接将x0作为struct返回值</span></span><br><span class="line">    <span class="number">0x1003b5b24</span> &lt;+<span class="number">32</span>&gt;: <span class="keyword">add</span>    <span class="built_in">sp</span>, <span class="built_in">sp</span>, <span class="number">#0x20</span>             <span class="comment">; =0x20 </span></span><br><span class="line">    <span class="number">0x1003b5b28</span> &lt;+<span class="number">36</span>&gt;: ret     </span><br></pre></td></tr></table></figure>
<p>可见，小型struct，可以直接放在寄存器中传递，和普通基本类型的传递没有太大的区别。</p>
<h4 id="大struct"><a href="#大struct" class="headerlink" title="大struct"></a>大struct</h4><p>那么struct足够的大呢，导致不能简单的用寄存器容纳struct的数据？</p>
<p>这里就要涉及到X8的一个特殊身份了(XR, indirect result location)，这里我们将<code>X8</code>记作<code>XR</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BigStruct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> arg1; <span class="type">int</span> arg2; <span class="type">int</span> arg3; <span class="type">int</span> arg4; <span class="type">int</span> arg5; <span class="type">int</span> arg6; <span class="type">int</span> arg7; <span class="type">int</span> arg8; <span class="type">int</span> arg9; <span class="type">int</span> arg10; <span class="type">int</span> arg11; <span class="type">int</span> arg12; <span class="type">int</span> arg13; <span class="type">char</span> *arg14;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> BigStruct <span class="title function_">bigStructFunc</span><span class="params">(<span class="type">int</span> arg1, <span class="keyword">struct</span> BigStruct arg2)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BigStruct</span> <span class="title">s</span> =</span> arg2;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">caller:</span></span><br><span class="line">    <span class="number">0x100791d3c</span> &lt;+<span class="number">228</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">x9</span>, <span class="built_in">x0</span></span><br><span class="line">    <span class="number">0x100791d40</span> &lt;+<span class="number">232</span>&gt;: stur   <span class="built_in">w9</span>, [<span class="built_in">x29</span>, #-<span class="number">0x38</span>]</span><br><span class="line">    <span class="number">0x100791d44</span> &lt;+<span class="number">236</span>&gt;: <span class="keyword">ldr</span>    <span class="built_in">x8</span>, [<span class="built_in">sp</span>, <span class="number">#0x80</span>]</span><br><span class="line">    <span class="number">0x100791d48</span> &lt;+<span class="number">240</span>&gt;: ldur   <span class="built_in">q0</span>, [<span class="built_in">x8</span>, <span class="number">#0x78</span>]</span><br><span class="line">    <span class="number">0x100791d4c</span> &lt;+<span class="number">244</span>&gt;: <span class="keyword">str</span>    <span class="built_in">q0</span>, [<span class="built_in">x8</span>, <span class="number">#0x30</span>]</span><br><span class="line">    <span class="number">0x100791d50</span> &lt;+<span class="number">248</span>&gt;: ldur   <span class="built_in">q0</span>, [<span class="built_in">x8</span>, <span class="number">#0x68</span>]</span><br><span class="line">    <span class="number">0x100791d54</span> &lt;+<span class="number">252</span>&gt;: stur   <span class="built_in">q0</span>, [<span class="built_in">x29</span>, #-<span class="number">0xa0</span>]</span><br><span class="line">    <span class="number">0x100791d58</span> &lt;+<span class="number">256</span>&gt;: ldur   <span class="built_in">q0</span>, [<span class="built_in">x8</span>, <span class="number">#0x58</span>]</span><br><span class="line">    <span class="number">0x100791d5c</span> &lt;+<span class="number">260</span>&gt;: stur   <span class="built_in">q0</span>, [<span class="built_in">x29</span>, #-<span class="number">0xb0</span>]</span><br><span class="line">    <span class="number">0x100791d60</span> &lt;+<span class="number">264</span>&gt;: ldur   <span class="built_in">q0</span>, [<span class="built_in">x8</span>, <span class="number">#0x48</span>]</span><br><span class="line">    <span class="number">0x100791d64</span> &lt;+<span class="number">268</span>&gt;: stur   <span class="built_in">q0</span>, [<span class="built_in">x29</span>, #-<span class="number">0xc0</span>]         <span class="comment">; 以上是将临时变量arg2赋值到Callee的参数栈区</span></span><br><span class="line">                                                         <span class="comment">; 这样子函数修改就不会改动原始数据了</span></span><br><span class="line">                                                         <span class="comment">; 为方便，后面将已拷贝的数据成为 arg2</span></span><br><span class="line">    <span class="number">0x100791d68</span> &lt;+<span class="number">272</span>&gt;: <span class="keyword">add</span>    <span class="built_in">x8</span>, <span class="built_in">sp</span>, <span class="number">#0xb0</span>             <span class="comment">; XR = SP + 0xb0 </span></span><br><span class="line">                                                         <span class="comment">; Callee save area</span></span><br><span class="line">                                                         <span class="comment">; 这是一个空的区域，用作返回的临时存储区</span></span><br><span class="line">    <span class="number">0x100791d6c</span> &lt;+<span class="number">276</span>&gt;: <span class="keyword">sub</span>    <span class="built_in">x1</span>, <span class="built_in">x29</span>, <span class="number">#0xc0</span>            <span class="comment">; x1 = FP - 0xc0 = &amp;arg2</span></span><br><span class="line">    <span class="number">0x100791d70</span> &lt;+<span class="number">280</span>&gt;: <span class="keyword">ldr</span>    <span class="built_in">w0</span>, [<span class="built_in">sp</span>, <span class="number">#0x7c</span>]           <span class="comment">; w0 = arg1</span></span><br><span class="line">    <span class="number">0x100791d74</span> &lt;+<span class="number">284</span>&gt;: <span class="keyword">bl</span>     <span class="number">0x100791b2c</span>               <span class="comment">; bigStructFunc at main.mm:36</span></span><br></pre></td></tr></table></figure>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">cfunction</span>`bigStructFunc:</span><br><span class="line">    <span class="number">0x1003b5b2c</span> &lt;+<span class="number">0</span>&gt;:  <span class="keyword">sub</span>    <span class="built_in">sp</span>, <span class="built_in">sp</span>, <span class="number">#0x20</span>             <span class="comment">; 申请栈空间 SP = SP0 - 0x20</span></span><br><span class="line">    <span class="number">0x1003b5b30</span> &lt;+<span class="number">4</span>&gt;:  stp    <span class="built_in">x29</span>, <span class="built_in">x30</span>, [<span class="built_in">sp</span>, <span class="number">#0x10</span>]     <span class="comment">; 这里和以上几个不同，是因为这里有函数调用，所以需要把LR和FP压栈</span></span><br><span class="line">    <span class="number">0x1003b5b34</span> &lt;+<span class="number">8</span>&gt;:  <span class="keyword">add</span>    <span class="built_in">x29</span>, <span class="built_in">sp</span>, <span class="number">#0x10</span>            </span><br><span class="line">    <span class="number">0x1003b5b38</span> &lt;+<span class="number">12</span>&gt;: <span class="keyword">orr</span>    <span class="built_in">x2</span>, xzr, <span class="number">#0x40</span>            <span class="comment">; struct 的 size = 0x40，作为第三个参数</span></span><br><span class="line">    <span class="number">0x1003b5b3c</span> &lt;+<span class="number">16</span>&gt;: stur   <span class="built_in">w0</span>, [<span class="built_in">x29</span>, #-<span class="number">0x4</span>]</span><br><span class="line">    <span class="number">0x1003b5b40</span> &lt;+<span class="number">20</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">x0</span>, <span class="built_in">x8</span>                    <span class="comment">; dst = x0 = XR = SP0 + 0xb0</span></span><br><span class="line">                                                        <span class="comment">; 第一个入参dst为caller的临时存储区</span></span><br><span class="line">                                                        <span class="comment">; 第二个参数为x1，也就是caller的 &amp;arg2</span></span><br><span class="line">    <span class="number">0x1003b5b44</span> &lt;+<span class="number">24</span>&gt;: <span class="keyword">bl</span>     <span class="number">0x1003b62f0</span>               <span class="comment">; symbol stub for: memcpy</span></span><br><span class="line">                                                        <span class="comment">; void *memcpy(void *dst, const void *src, size_t n);</span></span><br><span class="line">                                                        <span class="comment">; 这里居然直接调用了memcpy，赋值！</span></span><br><span class="line">    <span class="number">0x1003b5b48</span> &lt;+<span class="number">28</span>&gt;: ldp    <span class="built_in">x29</span>, <span class="built_in">x30</span>, [<span class="built_in">sp</span>, <span class="number">#0x10</span>]</span><br><span class="line">    <span class="number">0x1003b5b4c</span> &lt;+<span class="number">32</span>&gt;: <span class="keyword">add</span>    <span class="built_in">sp</span>, <span class="built_in">sp</span>, <span class="number">#0x20</span>             <span class="comment">; =0x20 </span></span><br><span class="line">    <span class="number">0x1003b5b50</span> &lt;+<span class="number">36</span>&gt;: ret    </span><br></pre></td></tr></table></figure>
<p>这样返回值就放在了<code>*XR</code>所在的位置，caller只需要再拷贝到临时变量区中即可。</p>
<p>可以看到，在处理大型struct时，就会出现多次内存拷贝，会对性能造成一定影响，所以这类方法尽量不要直接传递大型struct，可以传递指针或者引用，或者采用inline的方案，在优化期去除函数调用。</p>
<h4 id="struct参数的分界线"><a href="#struct参数的分界线" class="headerlink" title="struct参数的分界线"></a>struct参数的分界线</h4><p>根据<a target="_blank" rel="noopener" href="http://infocenter.arm.com/help/topic/com.arm.doc.ihi0055c/IHI0055C_beta_aapcs64.pdf">AAPCS 64</a>的<code>Parameter Passing Rules</code>节所述：</p>
<pre><code>If the argument is a Composite Type and the size in double-words of the argument is not more than 8 minus NGRN, then the argument is copied into consecutive general-purpose registers, starting at x[NGRN]. The argument is passed as though it had been loaded into the registers from a double-word- aligned address with an appropriate sequence of LDR instructions loading consecutive registers from memory (the contents of any unused parts of the registers are unspecified by this standard). The NGRN is incremented by the number of registers used. The argument has now been allocated.
</code></pre><p>大致说的是如果X0-X8中剩余的寄存器足够去保存该结构，那么就保存到寄存器，否则保存到栈。</p>
<pre><code>If the type, T, of the result of a function is such that
void func(T arg)
would require that arg be passed as a value in a register (or set of registers) according to the rules in §5.4 Parameter Passing, then the result is returned in the same registers as would be used for such an argument.
</code></pre><p>返回值也遵守以上规则。</p>
<p>这个文档不是最新的，而且是beta版，暂时没有找到正式版本。而且这里还涉及到很多其他的因素，所以这里也就不深究了。</p>
<h2 id="va-list"><a href="#va-list" class="headerlink" title="va_list"></a>va_list</h2><p>以上都是确定参数，那么如果是不确定参数，又是怎么传递的呢？</p>
<p>在<code>AAPCS 64</code>文档里有明确的说明，但是这里我们从汇编的角度来看这个问题。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">mutableAragsFunc</span><span class="params">(<span class="type">int</span> arg, ...)</span> &#123;</span><br><span class="line">    va_list <span class="built_in">list</span>;</span><br><span class="line">    va_start(<span class="built_in">list</span>, arg);</span><br><span class="line">    <span class="type">int</span> ret = arg;</span><br><span class="line">    <span class="keyword">while</span>(<span class="type">int</span> a = va_arg(<span class="built_in">list</span>, <span class="type">int</span>)) &#123;</span><br><span class="line">        ret += a;</span><br><span class="line">    &#125;</span><br><span class="line">    va_end(<span class="built_in">list</span>);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">mutableAragsFunc(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>在函数入口打断点，打印参数寄存器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x0 = 0x0000000000000001</span><br><span class="line">x1 = 0x000000016fce7930</span><br><span class="line">x2 = 0x000000016fce7a18</span><br><span class="line">x3 = 0x000000016fce7a90</span><br><span class="line">x4 = 0x0000000000000000</span><br><span class="line">x5 = 0x0000000000000000</span><br><span class="line">x6 = 0x0000000000000001</span><br><span class="line">x7 = 0x00000000000004b0</span><br></pre></td></tr></table></figure>
<p>可以发现除了x0是正确的第一个参数，其他都是随机的，那么说明参数肯定被放到了栈上。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">cfunction</span>`main:</span><br><span class="line">    <span class="number">0x100121be4</span> &lt;+<span class="number">0</span>&gt;:   <span class="keyword">sub</span>    <span class="built_in">sp</span>, <span class="built_in">sp</span>, <span class="number">#0xa0</span>             <span class="comment">; =0xa0 </span></span><br><span class="line">    <span class="number">0x100121be8</span> &lt;+<span class="number">4</span>&gt;:   stp    <span class="built_in">x29</span>, <span class="built_in">x30</span>, [<span class="built_in">sp</span>, <span class="number">#0x90</span>]</span><br><span class="line">    <span class="number">0x100121bec</span> &lt;+<span class="number">8</span>&gt;:   <span class="keyword">add</span>    <span class="built_in">x29</span>, <span class="built_in">sp</span>, <span class="number">#0x90</span>            <span class="comment">; =0x90 </span></span><br><span class="line">    <span class="number">0x100121bf0</span> &lt;+<span class="number">12</span>&gt;:  <span class="keyword">mov</span>    <span class="built_in">w8</span>, <span class="number">#0x0</span></span><br><span class="line">    <span class="number">0x100121bf4</span> &lt;+<span class="number">16</span>&gt;:  stur   <span class="built_in">w8</span>, [<span class="built_in">x29</span>, #-<span class="number">0x4</span>]</span><br><span class="line">    <span class="number">0x100121bf8</span> &lt;+<span class="number">20</span>&gt;:  stur   <span class="built_in">w0</span>, [<span class="built_in">x29</span>, #-<span class="number">0x8</span>]</span><br><span class="line">    <span class="number">0x100121bfc</span> &lt;+<span class="number">24</span>&gt;:  stur   <span class="built_in">x1</span>, [<span class="built_in">x29</span>, #-<span class="number">0x10</span>]</span><br><span class="line">    <span class="number">0x100121c00</span> &lt;+<span class="number">28</span>&gt;:  <span class="keyword">mov</span>    <span class="built_in">x1</span>, <span class="built_in">sp</span></span><br><span class="line">    <span class="number">0x100121c04</span> &lt;+<span class="number">32</span>&gt;:  <span class="keyword">mov</span>    <span class="built_in">x9</span>, <span class="number">#0x0</span></span><br><span class="line">    <span class="number">0x100121c08</span> &lt;+<span class="number">36</span>&gt;:  <span class="keyword">str</span>    <span class="built_in">x9</span>, [<span class="built_in">x1</span>, <span class="number">#0x10</span>]           <span class="comment">; 压栈 0</span></span><br><span class="line">    <span class="number">0x100121c0c</span> &lt;+<span class="number">40</span>&gt;:  <span class="keyword">orr</span>    <span class="built_in">w8</span>, wzr, <span class="number">#0x3</span></span><br><span class="line">    <span class="number">0x100121c10</span> &lt;+<span class="number">44</span>&gt;:  <span class="keyword">mov</span>    <span class="built_in">x9</span>, <span class="built_in">x8</span></span><br><span class="line">    <span class="number">0x100121c14</span> &lt;+<span class="number">48</span>&gt;:  <span class="keyword">str</span>    <span class="built_in">x9</span>, [<span class="built_in">x1</span>, <span class="number">#0x8</span>]            <span class="comment">; 压栈 3</span></span><br><span class="line">    <span class="number">0x100121c18</span> &lt;+<span class="number">52</span>&gt;:  <span class="keyword">orr</span>    <span class="built_in">w8</span>, wzr, <span class="number">#0x2</span></span><br><span class="line">    <span class="number">0x100121c1c</span> &lt;+<span class="number">56</span>&gt;:  <span class="keyword">mov</span>    <span class="built_in">x9</span>, <span class="built_in">x8</span></span><br><span class="line">    <span class="number">0x100121c20</span> &lt;+<span class="number">60</span>&gt;:  <span class="keyword">str</span>    <span class="built_in">x9</span>, [<span class="built_in">x1</span>]                  <span class="comment">; 压栈 2</span></span><br><span class="line">    <span class="number">0x100121c24</span> &lt;+<span class="number">64</span>&gt;:  <span class="keyword">orr</span>    <span class="built_in">w0</span>, wzr, <span class="number">#0x1</span>             <span class="comment">; arg = 1</span></span><br><span class="line">    <span class="number">0x100121c28</span> &lt;+<span class="number">68</span>&gt;:  <span class="keyword">bl</span>     <span class="number">0x1001218d8</span>               <span class="comment">; mutableAragsFunc at main.mm:67</span></span><br></pre></td></tr></table></figure>
<p>也就是表明被明确定义的参数，是按照上面所说的规则传递，而<code>...</code>参数全部按照栈方式传递。这从实现原理上也比较容易理解，在取va_arg的时候，只需要将栈指针+sizeof(type)就可以了。</p>
<h2 id="错误的函数签名"><a href="#错误的函数签名" class="headerlink" title="错误的函数签名"></a>错误的函数签名</h2><p>那么现在，我们回过头来看看第一个问题。C语言为什么会有函数签名？</p>
<p>函数签名决定了参数以及返回值的传递方式，同时还决定了函数栈帧的分布与大小，所以如果不确定函数签名，我们也就无法知道如何去传递参数了。</p>
<p>那么错误的函数签名会导致什么样的后果呢？运行时是否会崩溃？我们来看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">arg1_func</span><span class="params">(<span class="type">int</span> a)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">arg2_func</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">arg_test_func</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret1 = ((<span class="type">int</span> (*)(<span class="type">int</span>, <span class="type">int</span>))arg1_func)(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="type">int</span> ret2 = ((<span class="type">int</span> (*)(<span class="type">int</span>))arg2_func)(<span class="number">1</span>);</span><br><span class="line">    <span class="type">int</span> ret3 = ((<span class="type">int</span> (*)())arg1_func)();</span><br><span class="line">    <span class="type">int</span> ret4 = ((<span class="type">int</span> (*)())arg2_func)();</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d, %d, %d, %d\n&quot;</span>, ret1, ret2, ret3, ret4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先说结果，结果是一切运行正常，只是结果值有部分是错误的。那么我们来看看汇编代码：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">cfunction</span>`arg_test_func:</span><br><span class="line">    <span class="number">0x1003462cc</span> &lt;+<span class="number">0</span>&gt;:   <span class="keyword">sub</span>    <span class="built_in">sp</span>, <span class="built_in">sp</span>, <span class="number">#0x50</span>             <span class="comment">; =0x50 </span></span><br><span class="line">    <span class="number">0x1003462d0</span> &lt;+<span class="number">4</span>&gt;:   stp    <span class="built_in">x29</span>, <span class="built_in">x30</span>, [<span class="built_in">sp</span>, <span class="number">#0x40</span>]</span><br><span class="line">    <span class="number">0x1003462d4</span> &lt;+<span class="number">8</span>&gt;:   <span class="keyword">add</span>    <span class="built_in">x29</span>, <span class="built_in">sp</span>, <span class="number">#0x40</span>            <span class="comment">; =0x40 </span></span><br><span class="line">                                                         <span class="comment">; 以上都是处理栈帧</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x1003462d8</span> &lt;+<span class="number">12</span>&gt;:  <span class="keyword">orr</span>    <span class="built_in">w0</span>, wzr, <span class="number">#0x1</span>             <span class="comment">; w0 = 1</span></span><br><span class="line">    <span class="number">0x1003462dc</span> &lt;+<span class="number">16</span>&gt;:  <span class="keyword">orr</span>    <span class="built_in">w1</span>, wzr, <span class="number">#0x2</span>             <span class="comment">; w1 = 2</span></span><br><span class="line">    <span class="number">0x1003462e0</span> &lt;+<span class="number">20</span>&gt;:  <span class="keyword">bl</span>     <span class="number">0x100346298</span>               <span class="comment">; arg1_func at main.mm:87</span></span><br><span class="line">    <span class="number">0x1003462e4</span> &lt;+<span class="number">24</span>&gt;:  <span class="keyword">orr</span>    <span class="built_in">w1</span>, wzr, <span class="number">#0x1</span>             <span class="comment">; w1 = 1</span></span><br><span class="line">    <span class="number">0x1003462e8</span> &lt;+<span class="number">28</span>&gt;:  stur   <span class="built_in">w0</span>, [<span class="built_in">x29</span>, #-<span class="number">0x4</span>]          <span class="comment">; 将结果存入临时变量 ret1</span></span><br><span class="line">                                                         <span class="comment">; 按照寄存器的状态，这里相当于调用了 arg1_func(1)</span></span><br><span class="line">                                                         <span class="comment">; 其结果是正确的，只是可能没有符合预期</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x1003462ec</span> &lt;+<span class="number">32</span>&gt;:  <span class="keyword">mov</span>    <span class="built_in">x0</span>, <span class="built_in">x1</span>                    <span class="comment">; x0 = 1</span></span><br><span class="line">    <span class="number">0x1003462f0</span> &lt;+<span class="number">36</span>&gt;:  <span class="keyword">bl</span>     <span class="number">0x1003462ac</span>               <span class="comment">; arg2_func at main.mm:90</span></span><br><span class="line">    <span class="number">0x1003462f4</span> &lt;+<span class="number">40</span>&gt;:  stur   <span class="built_in">w0</span>, [<span class="built_in">x29</span>, #-<span class="number">0x8</span>]          <span class="comment">; 将结果存入临时变量 ret2</span></span><br><span class="line">                                                         <span class="comment">; 相当于 arg2_func(1, 1) = 2</span></span><br><span class="line">                                                         <span class="comment">; 第二个参数取决于上一次x1的状态</span></span><br><span class="line">                                                         <span class="comment">; 所以结果应该是随机的</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x1003462f8</span> &lt;+<span class="number">44</span>&gt;:  <span class="keyword">bl</span>     <span class="number">0x100346298</span>               <span class="comment">; arg1_func at main.mm:87</span></span><br><span class="line">    <span class="number">0x1003462fc</span> &lt;+<span class="number">48</span>&gt;:  stur   <span class="built_in">w0</span>, [<span class="built_in">x29</span>, #-<span class="number">0xc</span>]          <span class="comment">; 相当于 ret3 = arg1_func(2) = 2</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0x100346300</span> &lt;+<span class="number">52</span>&gt;:  <span class="keyword">bl</span>     <span class="number">0x1003462ac</span>               <span class="comment">; arg2_func at main.mm:90</span></span><br><span class="line">    <span class="number">0x100346304</span> &lt;+<span class="number">56</span>&gt;:  stur   <span class="built_in">w0</span>, [<span class="built_in">x29</span>, #-<span class="number">0x10</span>]         <span class="comment">; 相当于 ret4 = arg2_func(2, 1) = 3</span></span><br></pre></td></tr></table></figure>
<p>所以结果应该是<code>1, 2, 2, 3</code>。</p>
<p>这里的结果不能代表任何在其他环境下的结果，可以说其结果是难以预测的。这里没有奔溃也只是随机参数并不会带来奔溃的风险。</p>
<p>所以我们是不能用其他函数签名来传递参数的。</p>
<h2 id="obj-msgSend"><a href="#obj-msgSend" class="headerlink" title="obj_msgSend"></a>obj_msgSend</h2><p>接下来，我们来说说iOS中最著名的函数<code>obj_msgSend</code>，可以说，这个函数是objc的核心和基础，没有这个方法，就不存在objc。</p>
<p>根据我们上面的分析，理论上我们不能改变<code>obj_msgSend</code>的函数签名，来传递不同类型和个数的参数。那么苹果又是怎么实现的呢？</p>
<p>以前我们一直说<code>obj_msgSend</code>用汇编来写是为了速度，但这并不是主要原因，因为retain，release也是非常频繁使用的方法，为什么不把这几个也改为汇编呢。其实更重要的原因是如果用C来写<code>obj_msgSend</code>根本实现不了！</p>
<p>我们翻开苹果objc的源码，查看其中arm64.s汇编代码：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">ENTRY</span> _objc_msgSend</span><br><span class="line">    MESSENGER_START</span><br><span class="line"></span><br><span class="line">    <span class="keyword">cmp</span>    <span class="built_in">x0</span>, <span class="number">#0</span>               <span class="comment">// nil check and tagged pointer check</span></span><br><span class="line">    b.le    LNilOrTagged        <span class="comment">//  (MSB tagged pointer looks negative)</span></span><br><span class="line">    <span class="keyword">ldr</span>    <span class="built_in">x13</span>, [<span class="built_in">x0</span>]            <span class="comment">// x13 = isa</span></span><br><span class="line">    <span class="keyword">and</span>    <span class="built_in">x9</span>, <span class="built_in">x13</span>, <span class="symbol">#ISA_MASK</span>   <span class="comment">// x9 = class    </span></span><br><span class="line"><span class="symbol">LGetIsaDone:</span></span><br><span class="line">    CacheLookup NORMAL          <span class="comment">// calls imp or objc_msgSend_uncached</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">LNilOrTagged:</span></span><br><span class="line">    b.eq    LReturnZero         <span class="comment">// nil check</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// tagged</span></span><br><span class="line">    <span class="keyword">adrp</span>    <span class="built_in">x10</span>, _objc_debug_taggedpointer_classes<span class="comment">@PAGE</span></span><br><span class="line">    <span class="keyword">add</span>    <span class="built_in">x10</span>, <span class="built_in">x10</span>, _objc_debug_taggedpointer_classes<span class="comment">@PAGEOFF</span></span><br><span class="line">    <span class="keyword">ubfx</span>    <span class="built_in">x11</span>, <span class="built_in">x0</span>, <span class="number">#60</span>, <span class="number">#4</span></span><br><span class="line">    <span class="keyword">ldr</span>    <span class="built_in">x9</span>, [<span class="built_in">x10</span>, <span class="built_in">x11</span>, <span class="keyword">LSL</span> <span class="number">#3</span>]</span><br><span class="line">    <span class="keyword">b</span>    LGetIsaDone</span><br><span class="line"></span><br><span class="line"><span class="symbol">LReturnZero:</span></span><br><span class="line">    <span class="comment">// x0 is already zero</span></span><br><span class="line">    <span class="keyword">mov</span>    <span class="built_in">x1</span>, <span class="number">#0</span></span><br><span class="line">    movi    <span class="built_in">d0</span>, <span class="number">#0</span></span><br><span class="line">    movi    <span class="built_in">d1</span>, <span class="number">#0</span></span><br><span class="line">    movi    <span class="built_in">d2</span>, <span class="number">#0</span></span><br><span class="line">    movi    <span class="built_in">d3</span>, <span class="number">#0</span></span><br><span class="line">    MESSENGER_END_NIL</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">    END_ENTRY _objc_msgSend</span><br></pre></td></tr></table></figure>
<p>看出于上面其他C方法编译出来的汇编的区别了吗？</p>
<p>那就是<code>obj_msgSend</code>居然不存在栈帧！同时也没有任何地方修改过<code>X0-X7</code>,<code>X8</code>,<code>LR</code>,<code>SP</code>,<code>FP</code>！</p>
<p>而且当找到真正对象上的方法的时候，并不像其他方法一样使用<code>BL</code>，而是使用了</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.macro</span> CacheHit</span><br><span class="line"><span class="keyword">br</span>	<span class="built_in">x17</span>			<span class="comment">// call imp</span></span><br></pre></td></tr></table></figure>
<p>也就是说并没有修改<code>LR</code>。这样做的效果就相当于在函数调用的时候插入了一段代码！更像是c语言的宏。</p>
<p>由于<code>obj_msgSend</code>并没有改变任何方法调用的上下文，所以真正的objc方法就好像是被直接调用的一样。</p>
<p>可以说，这种想法实在是太精彩了。</p>
<h2 id="objc-msgSend对nil对象的处理"><a href="#objc-msgSend对nil对象的处理" class="headerlink" title="objc_msgSend对nil对象的处理"></a>objc_msgSend对nil对象的处理</h2><p>大家都知道，向空对象发送消息，返回的内容肯定都是0。那么这是为什么呢？</p>
<p>还是来看<code>obj_msgSend</code>的源代码部分，第一行就判断了nil：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmp</span>    <span class="built_in">x0</span>, <span class="number">#0</span>               <span class="comment">// nil check and tagged pointer check</span></span><br><span class="line"><span class="symbol">b.le</span>    LNilOrTagged        <span class="comment">//  (MSB tagged pointer looks negative)</span></span><br></pre></td></tr></table></figure>
<p>其中tagged pointer技术并不是我们本期的话题，所以我们直接跳到空对象的处理方法上：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">LReturnZero:</span></span><br><span class="line">    <span class="comment">// x0 is already zero</span></span><br><span class="line">    <span class="keyword">mov</span>    <span class="built_in">x1</span>, <span class="number">#0</span></span><br><span class="line">    movi    <span class="built_in">d0</span>, <span class="number">#0</span></span><br><span class="line">    movi    <span class="built_in">d1</span>, <span class="number">#0</span></span><br><span class="line">    movi    <span class="built_in">d2</span>, <span class="number">#0</span></span><br><span class="line">    movi    <span class="built_in">d3</span>, <span class="number">#0</span></span><br><span class="line">    MESSENGER_END_NIL</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>他将可能的保存返回值的寄存器全部写入0！（为什么会有多个寄存器，是因为ARM其实是支持向量运算的，所以在某些条件下会用多个寄存器保存返回值，具体可以去参考ARM官方文档）。</p>
<p>这样我们的返回值就只能是0了！</p>
<p>等等，还缺少一个类型，struct！如果是栈上的返回，上文已经分析过是保存在<code>X8</code>中的，可是我们并没有看到任何有关<code>X8</code>的操作。那么我们来写一个demo尝试一下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> struct_objc_nil(Test *t) &#123;</span><br><span class="line">    <span class="keyword">struct</span> BigStruct retB;</span><br><span class="line">    printf(<span class="string">&quot;stack: %d,%d,%d,%d,%d,%d,\n&quot;</span>, retB.arg1, retB.arg2, retB.arg3, retB.arg4, retB.arg5, retB.arg6);</span><br><span class="line">    retB = ((<span class="keyword">struct</span> BigStruct(*)(Test *, SEL))objc_msgSend)(t, <span class="keyword">@selector</span>(retStruct));</span><br><span class="line">    printf(<span class="string">&quot;msgSend: %d,%d,%d,%d,%d,%d,\n&quot;</span>, retB.arg1, retB.arg2, retB.arg3, retB.arg4, retB.arg5, retB.arg6);</span><br><span class="line">    retB = [t retStruct];</span><br><span class="line">    printf(<span class="string">&quot;objc: %d,%d,%d,%d,%d,%d,\n&quot;</span>, retB.arg1, retB.arg2, retB.arg3, retB.arg4, retB.arg5, retB.arg6);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先我们打开编译优化<code>-os</code>(非优化状态，栈空间会被清0)。其结果居然是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stack: 50462976,185207048,0,0,0,0,</span><br><span class="line">msgSend: 1,0,992,0,0,0,</span><br><span class="line">objc: 0,0,0,0,0,0,</span><br></pre></td></tr></table></figure>
<p>struct类型两者的返回并不一致！按照我们阅读源码来推论，随机数值才是正确的结果，这是为什么呢？</p>
<p>我们还是来看汇编，我将关键部分特意标注了出来：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">cfunction</span>`struct_objc_nil:</span><br><span class="line">    <span class="number">0x10097e754</span> &lt;+<span class="number">0</span>&gt;:   <span class="keyword">sub</span>    <span class="built_in">sp</span>, <span class="built_in">sp</span>, <span class="number">#0x90</span>             <span class="comment">; =0x90 </span></span><br><span class="line">    <span class="number">0x10097e758</span> &lt;+<span class="number">4</span>&gt;:   stp    <span class="built_in">x20</span>, <span class="built_in">x19</span>, [<span class="built_in">sp</span>, <span class="number">#0x70</span>]</span><br><span class="line">    <span class="number">0x10097e75c</span> &lt;+<span class="number">8</span>&gt;:   stp    <span class="built_in">x29</span>, <span class="built_in">x30</span>, [<span class="built_in">sp</span>, <span class="number">#0x80</span>]</span><br><span class="line">    <span class="number">0x10097e760</span> &lt;+<span class="number">12</span>&gt;:  <span class="keyword">add</span>    <span class="built_in">x29</span>, <span class="built_in">sp</span>, <span class="number">#0x80</span>            <span class="comment">; =0x80 </span></span><br><span class="line">    <span class="number">0x10097e764</span> &lt;+<span class="number">16</span>&gt;:  <span class="keyword">bl</span>     <span class="number">0x10097e9d4</span>               <span class="comment">; symbol stub for: objc_retain</span></span><br><span class="line">    <span class="number">0x10097e768</span> &lt;+<span class="number">20</span>&gt;:  <span class="keyword">mov</span>    <span class="built_in">x19</span>, <span class="built_in">x0</span></span><br><span class="line">    <span class="number">0x10097e76c</span> &lt;+<span class="number">24</span>&gt;:  <span class="keyword">adr</span>    <span class="built_in">x0</span>, <span class="number">#0x1730</span>               <span class="comment">; &quot;stack: %d,%d,%d,%d,%d,%d,\n&quot;</span></span><br><span class="line">    <span class="number">0x10097e770</span> &lt;+<span class="number">28</span>&gt;:  <span class="keyword">nop</span>    </span><br><span class="line">    <span class="number">0x10097e774</span> &lt;+<span class="number">32</span>&gt;:  <span class="keyword">bl</span>     <span class="number">0x10097e9f8</span>               <span class="comment">; symbol stub for: printf</span></span><br><span class="line">    <span class="number">0x10097e778</span> &lt;+<span class="number">36</span>&gt;:  <span class="keyword">nop</span>    </span><br><span class="line">    <span class="number">0x10097e77c</span> &lt;+<span class="number">40</span>&gt;:  <span class="keyword">ldr</span>    <span class="built_in">x20</span>, <span class="number">#0x262c</span>              <span class="comment">; &quot;retStruct&quot;</span></span><br><span class="line">    <span class="number">0x10097e780</span> &lt;+<span class="number">44</span>&gt;:  <span class="keyword">add</span>    <span class="built_in">x8</span>, <span class="built_in">sp</span>, <span class="number">#0x30</span>             <span class="comment">; =0x30 </span></span><br><span class="line">    <span class="number">0x10097e784</span> &lt;+<span class="number">48</span>&gt;:  <span class="keyword">mov</span>    <span class="built_in">x0</span>, <span class="built_in">x19</span></span><br><span class="line">    <span class="number">0x10097e788</span> &lt;+<span class="number">52</span>&gt;:  <span class="keyword">mov</span>    <span class="built_in">x1</span>, <span class="built_in">x20</span></span><br><span class="line">    <span class="number">0x10097e78c</span> &lt;+<span class="number">56</span>&gt;:  <span class="keyword">bl</span>     <span class="number">0x10097e9b0</span>               <span class="comment">; symbol stub for: objc_msgSend</span></span><br><span class="line">    <span class="number">0x10097e790</span> &lt;+<span class="number">60</span>&gt;:  ldp    <span class="built_in">w8</span>, <span class="built_in">w9</span>, [<span class="built_in">sp</span>, <span class="number">#0x30</span>]</span><br><span class="line">    <span class="number">0x10097e794</span> &lt;+<span class="number">64</span>&gt;:  ldp    <span class="built_in">w10</span>, <span class="built_in">w11</span>, [<span class="built_in">sp</span>, <span class="number">#0x38</span>]</span><br><span class="line">    <span class="number">0x10097e798</span> &lt;+<span class="number">68</span>&gt;:  ldp    <span class="built_in">w12</span>, <span class="built_in">w13</span>, [<span class="built_in">sp</span>, <span class="number">#0x40</span>]</span><br><span class="line">    <span class="number">0x10097e79c</span> &lt;+<span class="number">72</span>&gt;:  stp    <span class="built_in">x12</span>, <span class="built_in">x13</span>, [<span class="built_in">sp</span>, <span class="number">#0x20</span>]</span><br><span class="line">    <span class="number">0x10097e7a0</span> &lt;+<span class="number">76</span>&gt;:  stp    <span class="built_in">x10</span>, <span class="built_in">x11</span>, [<span class="built_in">sp</span>, <span class="number">#0x10</span>]</span><br><span class="line">    <span class="number">0x10097e7a4</span> &lt;+<span class="number">80</span>&gt;:  stp    <span class="built_in">x8</span>, <span class="built_in">x9</span>, [<span class="built_in">sp</span>]</span><br><span class="line">    <span class="number">0x10097e7a8</span> &lt;+<span class="number">84</span>&gt;:  <span class="keyword">adr</span>    <span class="built_in">x0</span>, <span class="number">#0x170f</span>               <span class="comment">; &quot;msgSend: %d,%d,%d,%d,%d,%d,\n&quot;</span></span><br><span class="line">    <span class="number">0x10097e7ac</span> &lt;+<span class="number">88</span>&gt;:  <span class="keyword">nop</span>    </span><br><span class="line">    <span class="number">0x10097e7b0</span> &lt;+<span class="number">92</span>&gt;:  <span class="keyword">bl</span>     <span class="number">0x10097e9f8</span>               <span class="comment">; symbol stub for: printf</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//////////////////////////////////////////////////////////</span></span><br><span class="line">-&gt;  <span class="number">0x10097e7b4</span> &lt;+<span class="number">96</span>&gt;:  <span class="keyword">cbz</span>    <span class="built_in">x19</span>, <span class="number">0x10097e7d8</span>          <span class="comment">; &lt;+132&gt; at main.mm:134</span></span><br><span class="line">                                                         <span class="comment">; 这里的意思是：</span></span><br><span class="line">                                                         <span class="comment">; IF X19 == NULL THEN</span></span><br><span class="line">                                                         <span class="comment">;    GOTO 0x10097e7d8</span></span><br><span class="line">                                                         <span class="comment">; 而 0x10097e7d8 就是内存清0的地方！</span></span><br><span class="line">                                                         <span class="comment">; X19 在 0x10097e768 被赋值为 objc 对象 &#x27;nil&#x27;</span></span><br><span class="line">                                                         <span class="comment">; 而在第一次调用 &#x27;obj_msgSend&#x27; 就没有这一段！</span></span><br><span class="line">                                                         <span class="comment">; （由于优化，有些逻辑和代码中有变化）</span></span><br><span class="line">    <span class="comment">//////////////////////////////////////////////////////////</span></span><br><span class="line">    </span><br><span class="line">    <span class="number">0x10097e7b8</span> &lt;+<span class="number">100</span>&gt;: <span class="keyword">add</span>    <span class="built_in">x8</span>, <span class="built_in">sp</span>, <span class="number">#0x30</span>             <span class="comment">; =0x30 </span></span><br><span class="line">    <span class="number">0x10097e7bc</span> &lt;+<span class="number">104</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">x0</span>, <span class="built_in">x19</span></span><br><span class="line">    <span class="number">0x10097e7c0</span> &lt;+<span class="number">108</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">x1</span>, <span class="built_in">x20</span></span><br><span class="line">    <span class="number">0x10097e7c4</span> &lt;+<span class="number">112</span>&gt;: <span class="keyword">bl</span>     <span class="number">0x10097e9b0</span>               <span class="comment">; symbol stub for: objc_msgSend</span></span><br><span class="line">    <span class="number">0x10097e7c8</span> &lt;+<span class="number">116</span>&gt;: ldp    <span class="built_in">w8</span>, <span class="built_in">w9</span>, [<span class="built_in">sp</span>, <span class="number">#0x30</span>]</span><br><span class="line">    <span class="number">0x10097e7cc</span> &lt;+<span class="number">120</span>&gt;: ldp    <span class="built_in">w10</span>, <span class="built_in">w11</span>, [<span class="built_in">sp</span>, <span class="number">#0x38</span>]</span><br><span class="line">    <span class="number">0x10097e7d0</span> &lt;+<span class="number">124</span>&gt;: ldp    <span class="built_in">w12</span>, <span class="built_in">w13</span>, [<span class="built_in">sp</span>, <span class="number">#0x40</span>]</span><br><span class="line">    <span class="number">0x10097e7d4</span> &lt;+<span class="number">128</span>&gt;: <span class="keyword">b</span>      <span class="number">0x10097e800</span>               <span class="comment">; &lt;+172&gt; at main.mm:135</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                                         <span class="comment">; 这里有一段清0的代码！正好就是返回值的局部变量地址</span></span><br><span class="line">    <span class="number">0x10097e7d8</span> &lt;+<span class="number">132</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">w13</span>, <span class="number">#0x0</span></span><br><span class="line">    <span class="number">0x10097e7dc</span> &lt;+<span class="number">136</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">w12</span>, <span class="number">#0x0</span></span><br><span class="line">    <span class="number">0x10097e7e0</span> &lt;+<span class="number">140</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">w11</span>, <span class="number">#0x0</span></span><br><span class="line">    <span class="number">0x10097e7e4</span> &lt;+<span class="number">144</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">w10</span>, <span class="number">#0x0</span></span><br><span class="line">    <span class="number">0x10097e7e8</span> &lt;+<span class="number">148</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">w9</span>, <span class="number">#0x0</span></span><br><span class="line">    <span class="number">0x10097e7ec</span> &lt;+<span class="number">152</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">w8</span>, <span class="number">#0x0</span></span><br><span class="line">    <span class="number">0x10097e7f0</span> &lt;+<span class="number">156</span>&gt;: stp    xzr, xzr, [<span class="built_in">sp</span>, <span class="number">#0x60</span>]</span><br><span class="line">    <span class="number">0x10097e7f4</span> &lt;+<span class="number">160</span>&gt;: stp    xzr, xzr, [<span class="built_in">sp</span>, <span class="number">#0x50</span>]</span><br><span class="line">    <span class="number">0x10097e7f8</span> &lt;+<span class="number">164</span>&gt;: stp    xzr, xzr, [<span class="built_in">sp</span>, <span class="number">#0x40</span>]</span><br><span class="line">    <span class="number">0x10097e7fc</span> &lt;+<span class="number">168</span>&gt;: stp    xzr, xzr, [<span class="built_in">sp</span>, <span class="number">#0x30</span>]</span><br><span class="line">    <span class="number">0x10097e800</span> &lt;+<span class="number">172</span>&gt;: stp    <span class="built_in">x12</span>, <span class="built_in">x13</span>, [<span class="built_in">sp</span>, <span class="number">#0x20</span>]</span><br><span class="line">    <span class="number">0x10097e804</span> &lt;+<span class="number">176</span>&gt;: stp    <span class="built_in">x10</span>, <span class="built_in">x11</span>, [<span class="built_in">sp</span>, <span class="number">#0x10</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="number">0x10097e808</span> &lt;+<span class="number">180</span>&gt;: stp    <span class="built_in">x8</span>, <span class="built_in">x9</span>, [<span class="built_in">sp</span>]</span><br><span class="line">    <span class="number">0x10097e80c</span> &lt;+<span class="number">184</span>&gt;: <span class="keyword">adr</span>    <span class="built_in">x0</span>, <span class="number">#0x16c8</span>               <span class="comment">; &quot;objc: %d,%d,%d,%d,%d,%d,\n&quot;</span></span><br><span class="line">    <span class="number">0x10097e810</span> &lt;+<span class="number">188</span>&gt;: <span class="keyword">nop</span>    </span><br><span class="line">    <span class="number">0x10097e814</span> &lt;+<span class="number">192</span>&gt;: <span class="keyword">bl</span>     <span class="number">0x10097e9f8</span>               <span class="comment">; symbol stub for: printf</span></span><br><span class="line">    <span class="number">0x10097e818</span> &lt;+<span class="number">196</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">x0</span>, <span class="built_in">x19</span></span><br><span class="line">    <span class="number">0x10097e81c</span> &lt;+<span class="number">200</span>&gt;: <span class="keyword">bl</span>     <span class="number">0x10097e9c8</span>               <span class="comment">; symbol stub for: objc_release</span></span><br><span class="line">    <span class="number">0x10097e820</span> &lt;+<span class="number">204</span>&gt;: ldp    <span class="built_in">x29</span>, <span class="built_in">x30</span>, [<span class="built_in">sp</span>, <span class="number">#0x80</span>]</span><br><span class="line">    <span class="number">0x10097e824</span> &lt;+<span class="number">208</span>&gt;: ldp    <span class="built_in">x20</span>, <span class="built_in">x19</span>, [<span class="built_in">sp</span>, <span class="number">#0x70</span>]</span><br><span class="line">    <span class="number">0x10097e828</span> &lt;+<span class="number">212</span>&gt;: <span class="keyword">add</span>    <span class="built_in">sp</span>, <span class="built_in">sp</span>, <span class="number">#0x90</span>             <span class="comment">; =0x90 </span></span><br><span class="line">    <span class="number">0x10097e82c</span> &lt;+<span class="number">216</span>&gt;: ret    </span><br><span class="line">    <span class="number">0x10097e830</span> &lt;+<span class="number">220</span>&gt;: <span class="keyword">b</span>      <span class="number">0x10097e834</span>               <span class="comment">; &lt;+224&gt; at main.mm</span></span><br><span class="line">    <span class="number">0x10097e834</span> &lt;+<span class="number">224</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">x20</span>, <span class="built_in">x0</span></span><br><span class="line">    <span class="number">0x10097e838</span> &lt;+<span class="number">228</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">x0</span>, <span class="built_in">x19</span></span><br><span class="line">    <span class="number">0x10097e83c</span> &lt;+<span class="number">232</span>&gt;: <span class="keyword">bl</span>     <span class="number">0x10097e9c8</span>               <span class="comment">; symbol stub for: objc_release</span></span><br><span class="line">    <span class="number">0x10097e840</span> &lt;+<span class="number">236</span>&gt;: <span class="keyword">mov</span>    <span class="built_in">x0</span>, <span class="built_in">x20</span></span><br><span class="line">    <span class="number">0x10097e844</span> &lt;+<span class="number">240</span>&gt;: <span class="keyword">bl</span>     <span class="number">0x10097e98c</span>               <span class="comment">; symbol stub for: _Unwind_Resume</span></span><br></pre></td></tr></table></figure>
<p>到这里我们就能够明白了，为什么struct返回值也会变成0。是编译器给我们加入了一段判定的代码！</p>
<p>那么’objc空对象的返回值一定是0’这个判定就需要在一定条件下了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>对这一部分的探索一直持续了很久，一直是迷糊状态，不过经过长时间的多次探索，慢慢思考，总算有一个比较清晰的认识了。可以说底层的东西真的很多很复杂，这里只是其中很小的一方面，其他方面等有时间了另外再写吧。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0801g/DUI0801G_armasm_user_guide.pdf">armasm_user_guide</a></p>
<p><a target="_blank" rel="noopener" href="http://infocenter.arm.com/help/topic/com.arm.doc.den0024a/DEN0024A_v8_architecture_PG.pdf">ABI</a></p>
<p><a target="_blank" rel="noopener" href="http://infocenter.arm.com/help/topic/com.arm.doc.ihi0055c/IHI0055C_beta_aapcs64.pdf">AAPCS</a></p>
<p><a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/Using-Assembly-Language-with-C.html#Using-Assembly-Language-with-C">GNU C &amp; ASM</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/DeveloperTools/Reference/Assembler/000-Introduction/introduction.html">Apple ASM</a></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color2">C</a>
        		</li>
      		 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">ARM</a>
        		</li>
      		 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">ASM</a>
        		</li>
      		
		</ul>
	</div>

      
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/iOS/" class="article-tag-list-link color4">iOS</a>
        		</li>
      		
		</ul>
	</div>


      

      
        
<div class="share-btn share-icons tooltip-left">
  <div class="tooltip tooltip-east">
    <span class="tooltip-item">
      <a href="javascript:;" class="share-sns share-outer">
        <i class="icon icon-share"></i>
      </a>
    </span>
    <span class="tooltip-content">
      <div class="share-wrap">
        <div class="share-icons">
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="icon icon-weibo"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="icon icon-weixin"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="icon icon-qq"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="icon icon-douban"></i>
          </a>
          <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a>
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="icon icon-facebook"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="icon icon-twitter"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="icon icon-google"></i>
          </a>
        </div>
      </div>
    </span>
  </div>
</div>

<div class="page-modal wx-share js-wx-box">
    <a class="close js-modal-close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="http://s.jiathis.com/qrcode.php?url=http://djs66256.github.io/2018/01/11/2018-01-11-C%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E5%8F%82%E6%95%B0%E4%B8%8EARM%E6%B1%87%E7%BC%96/" alt="微信分享二维码">
    </div>
</div>

<div class="mask js-mask"></div>
      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
    <a href="/2018/01/21/2018-01-21-%E8%BF%90%E8%A1%8C%E6%97%B6%E8%8E%B7%E5%8F%96%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%A0%88/" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          运行时获取函数调用栈
        
      </div>
    </a>
  
  
    <a href="/2017/12/30/2017-12-30-2017%E5%B9%B4%E6%80%BB%E7%BB%93/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">2017年总结</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>






  
    <!-- <div class="duoshuo"></div> -->
  



<section id="comments">
  <div id="disqus_thread"></div>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'djs66256'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2025 苍耳
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>!function(t){function n(r){if(e[r])return e[r].exports;var o=e[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var e={};return n.m=t,n.c=e,n.p="./",n(0)}([function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,n){var e=/\/|index.html/g;return t.replace(e,"")===n.replace(e,"")}function i(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,e=0,r=t.length;e<r;e++){var i=t[e];o(n,i.getAttribute("href"))&&(0,d.default)(i,"active")}}function u(t){for(var n=t.offsetLeft,e=t.offsetParent;null!==e;)n+=e.offsetLeft,e=e.offsetParent;return n}function f(t){for(var n=t.offsetTop,e=t.offsetParent;null!==e;)n+=e.offsetTop,e=e.offsetParent;return n}function c(t,n,e,r,o){var i=u(t),c=f(t)-n;if(c-e<=o){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,h.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(e||c)+"px",a.style.left=i+"px",a.style.zIndex=r||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");c(t,document.body.scrollTop,-63,2,0),c(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}function l(){x.default.versions.mobile&&window.screen.width<800&&(i(),s())}var p=e(71),d=r(p),v=e(72),y=(r(v),e(84)),h=r(y),b=e(69),x=r(b),m=e(75),g=r(m),w=e(70);l(),(0,w.addLoadEvent)(function(){g.default.init()}),t.exports={}},function(t,n){var e=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)},function(t,n){var e={}.hasOwnProperty;t.exports=function(t,n){return e.call(t,n)}},function(t,n,e){var r=e(49),o=e(15);t.exports=function(t){return r(o(t))}},function(t,n,e){t.exports=!e(8)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,e){var r=e(6),o=e(12);t.exports=e(4)?function(t,n,e){return r.f(t,n,o(1,e))}:function(t,n,e){return t[n]=e,t}},function(t,n,e){var r=e(10),o=e(30),i=e(24),u=Object.defineProperty;n.f=e(4)?Object.defineProperty:function(t,n,e){if(r(t),n=i(n,!0),r(e),o)try{return u(t,n,e)}catch(t){}if("get"in e||"set"in e)throw TypeError("Accessors not supported!");return"value"in e&&(t[n]=e.value),t}},function(t,n,e){var r=e(22)("wks"),o=e(13),i=e(1).Symbol,u="function"==typeof i,f=t.exports=function(t){return r[t]||(r[t]=u&&i[t]||(u?i:o)("Symbol."+t))};f.store=r},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,e){var r=e(35),o=e(16);t.exports=Object.keys||function(t){return r(t,o)}},function(t,n,e){var r=e(11);t.exports=function(t){if(!r(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var e=0,r=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++e+r).toString(36))}},function(t,n){var e=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=e)},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,e){var r=e(6).f,o=e(2),i=e(7)("toStringTag");t.exports=function(t,n,e){t&&!o(t=e?t:t.prototype,i)&&r(t,i,{configurable:!0,value:n})}},function(t,n,e){var r=e(22)("keys"),o=e(13);t.exports=function(t){return r[t]||(r[t]=o(t))}},function(t,n,e){var r=e(1),o="__core-js_shared__",i=r[o]||(r[o]={});t.exports=function(t){return i[t]||(i[t]={})}},function(t,n){var e=Math.ceil,r=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?r:e)(t)}},function(t,n,e){var r=e(11);t.exports=function(t,n){if(!r(t))return t;var e,o;if(n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;if("function"==typeof(e=t.valueOf)&&!r(o=e.call(t)))return o;if(!n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;throw TypeError("Can't convert object to primitive value")}},function(t,n,e){var r=e(1),o=e(14),i=e(18),u=e(26),f=e(6).f;t.exports=function(t){var n=o.Symbol||(o.Symbol=i?{}:r.Symbol||{});"_"==t.charAt(0)||t in n||f(n,t,{value:u.f(t)})}},function(t,n,e){n.f=e(7)},function(t,n,e){var r=e(1),o=e(14),i=e(46),u=e(5),f="prototype",c=function(t,n,e){var a,s,l,p=t&c.F,d=t&c.G,v=t&c.S,y=t&c.P,h=t&c.B,b=t&c.W,x=d?o:o[n]||(o[n]={}),m=x[f],g=d?r:v?r[n]:(r[n]||{})[f];d&&(e=n);for(a in e)s=!p&&g&&void 0!==g[a],s&&a in x||(l=s?g[a]:e[a],x[a]=d&&"function"!=typeof g[a]?e[a]:h&&s?i(l,r):b&&g[a]==l?function(t){var n=function(n,e,r){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,e)}return new t(n,e,r)}return t.apply(this,arguments)};return n[f]=t[f],n}(l):y&&"function"==typeof l?i(Function.call,l):l,y&&((x.virtual||(x.virtual={}))[a]=l,t&c.R&&m&&!m[a]&&u(m,a,l)))};c.F=1,c.G=2,c.S=4,c.P=8,c.B=16,c.W=32,c.U=64,c.R=128,t.exports=c},function(t,n){var e={}.toString;t.exports=function(t){return e.call(t).slice(8,-1)}},function(t,n,e){var r=e(11),o=e(1).document,i=r(o)&&r(o.createElement);t.exports=function(t){return i?o.createElement(t):{}}},function(t,n,e){t.exports=!e(4)&&!e(8)(function(){return 7!=Object.defineProperty(e(29)("div"),"a",{get:function(){return 7}}).a})},function(t,n,e){"use strict";var r=e(18),o=e(27),i=e(36),u=e(5),f=e(2),c=e(17),a=e(51),s=e(20),l=e(58),p=e(7)("iterator"),d=!([].keys&&"next"in[].keys()),v="@@iterator",y="keys",h="values",b=function(){return this};t.exports=function(t,n,e,x,m,g,w){a(e,n,x);var O,S,_,j=function(t){if(!d&&t in A)return A[t];switch(t){case y:return function(){return new e(this,t)};case h:return function(){return new e(this,t)}}return function(){return new e(this,t)}},P=n+" Iterator",E=m==h,M=!1,A=t.prototype,T=A[p]||A[v]||m&&A[m],L=T||j(m),N=m?E?j("entries"):L:void 0,C="Array"==n?A.entries||T:T;if(C&&(_=l(C.call(new t)),_!==Object.prototype&&(s(_,P,!0),r||f(_,p)||u(_,p,b))),E&&T&&T.name!==h&&(M=!0,L=function(){return T.call(this)}),r&&!w||!d&&!M&&A[p]||u(A,p,L),c[n]=L,c[P]=b,m)if(O={values:E?L:j(h),keys:g?L:j(y),entries:N},w)for(S in O)S in A||i(A,S,O[S]);else o(o.P+o.F*(d||M),n,O);return O}},function(t,n,e){var r=e(10),o=e(55),i=e(16),u=e(21)("IE_PROTO"),f=function(){},c="prototype",a=function(){var t,n=e(29)("iframe"),r=i.length,o="<",u=">";for(n.style.display="none",e(48).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write(o+"script"+u+"document.F=Object"+o+"/script"+u),t.close(),a=t.F;r--;)delete a[c][i[r]];return a()};t.exports=Object.create||function(t,n){var e;return null!==t?(f[c]=r(t),e=new f,f[c]=null,e[u]=t):e=a(),void 0===n?e:o(e,n)}},function(t,n,e){var r=e(35),o=e(16).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return r(t,o)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,e){var r=e(2),o=e(3),i=e(45)(!1),u=e(21)("IE_PROTO");t.exports=function(t,n){var e,f=o(t),c=0,a=[];for(e in f)e!=u&&r(f,e)&&a.push(e);for(;n.length>c;)r(f,e=n[c++])&&(~i(a,e)||a.push(e));return a}},function(t,n,e){t.exports=e(5)},function(t,n,e){var r=e(15);t.exports=function(t){return Object(r(t))}},function(t,n,e){t.exports={default:e(41),__esModule:!0}},function(t,n,e){t.exports={default:e(42),__esModule:!0}},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var o=e(39),i=r(o),u=e(38),f=r(u),c="function"==typeof f.default&&"symbol"==typeof i.default?function(t){return typeof t}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":typeof t};n.default="function"==typeof f.default&&"symbol"===c(i.default)?function(t){return"undefined"==typeof t?"undefined":c(t)}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":"undefined"==typeof t?"undefined":c(t)}},function(t,n,e){e(65),e(63),e(66),e(67),t.exports=e(14).Symbol},function(t,n,e){e(64),e(68),t.exports=e(26).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,e){var r=e(3),o=e(61),i=e(60);t.exports=function(t){return function(n,e,u){var f,c=r(n),a=o(c.length),s=i(u,a);if(t&&e!=e){for(;a>s;)if(f=c[s++],f!=f)return!0}else for(;a>s;s++)if((t||s in c)&&c[s]===e)return t||s||0;return!t&&-1}}},function(t,n,e){var r=e(43);t.exports=function(t,n,e){if(r(t),void 0===n)return t;switch(e){case 1:return function(e){return t.call(n,e)};case 2:return function(e,r){return t.call(n,e,r)};case 3:return function(e,r,o){return t.call(n,e,r,o)}}return function(){return t.apply(n,arguments)}}},function(t,n,e){var r=e(9),o=e(34),i=e(19);t.exports=function(t){var n=r(t),e=o.f;if(e)for(var u,f=e(t),c=i.f,a=0;f.length>a;)c.call(t,u=f[a++])&&n.push(u);return n}},function(t,n,e){t.exports=e(1).document&&document.documentElement},function(t,n,e){var r=e(28);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==r(t)?t.split(""):Object(t)}},function(t,n,e){var r=e(28);t.exports=Array.isArray||function(t){return"Array"==r(t)}},function(t,n,e){"use strict";var r=e(32),o=e(12),i=e(20),u={};e(5)(u,e(7)("iterator"),function(){return this}),t.exports=function(t,n,e){t.prototype=r(u,{next:o(1,e)}),i(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,e){var r=e(9),o=e(3);t.exports=function(t,n){for(var e,i=o(t),u=r(i),f=u.length,c=0;f>c;)if(i[e=u[c++]]===n)return e}},function(t,n,e){var r=e(13)("meta"),o=e(11),i=e(2),u=e(6).f,f=0,c=Object.isExtensible||function(){return!0},a=!e(8)(function(){return c(Object.preventExtensions({}))}),s=function(t){u(t,r,{value:{i:"O"+ ++f,w:{}}})},l=function(t,n){if(!o(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!i(t,r)){if(!c(t))return"F";if(!n)return"E";s(t)}return t[r].i},p=function(t,n){if(!i(t,r)){if(!c(t))return!0;if(!n)return!1;s(t)}return t[r].w},d=function(t){return a&&v.NEED&&c(t)&&!i(t,r)&&s(t),t},v=t.exports={KEY:r,NEED:!1,fastKey:l,getWeak:p,onFreeze:d}},function(t,n,e){var r=e(6),o=e(10),i=e(9);t.exports=e(4)?Object.defineProperties:function(t,n){o(t);for(var e,u=i(n),f=u.length,c=0;f>c;)r.f(t,e=u[c++],n[e]);return t}},function(t,n,e){var r=e(19),o=e(12),i=e(3),u=e(24),f=e(2),c=e(30),a=Object.getOwnPropertyDescriptor;n.f=e(4)?a:function(t,n){if(t=i(t),n=u(n,!0),c)try{return a(t,n)}catch(t){}if(f(t,n))return o(!r.f.call(t,n),t[n])}},function(t,n,e){var r=e(3),o=e(33).f,i={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],f=function(t){try{return o(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==i.call(t)?f(t):o(r(t))}},function(t,n,e){var r=e(2),o=e(37),i=e(21)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=o(t),r(t,i)?t[i]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,e){var r=e(23),o=e(15);t.exports=function(t){return function(n,e){var i,u,f=String(o(n)),c=r(e),a=f.length;return c<0||c>=a?t?"":void 0:(i=f.charCodeAt(c),i<55296||i>56319||c+1===a||(u=f.charCodeAt(c+1))<56320||u>57343?t?f.charAt(c):i:t?f.slice(c,c+2):(i-55296<<10)+(u-56320)+65536)}}},function(t,n,e){var r=e(23),o=Math.max,i=Math.min;t.exports=function(t,n){return t=r(t),t<0?o(t+n,0):i(t,n)}},function(t,n,e){var r=e(23),o=Math.min;t.exports=function(t){return t>0?o(r(t),9007199254740991):0}},function(t,n,e){"use strict";var r=e(44),o=e(52),i=e(17),u=e(3);t.exports=e(31)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,e=this._i++;return!t||e>=t.length?(this._t=void 0,o(1)):"keys"==n?o(0,e):"values"==n?o(0,t[e]):o(0,[e,t[e]])},"values"),i.Arguments=i.Array,r("keys"),r("values"),r("entries")},function(t,n){},function(t,n,e){"use strict";var r=e(59)(!0);e(31)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,e=this._i;return e>=n.length?{value:void 0,done:!0}:(t=r(n,e),this._i+=t.length,{value:t,done:!1})})},function(t,n,e){"use strict";var r=e(1),o=e(2),i=e(4),u=e(27),f=e(36),c=e(54).KEY,a=e(8),s=e(22),l=e(20),p=e(13),d=e(7),v=e(26),y=e(25),h=e(53),b=e(47),x=e(50),m=e(10),g=e(3),w=e(24),O=e(12),S=e(32),_=e(57),j=e(56),P=e(6),E=e(9),M=j.f,A=P.f,T=_.f,L=r.Symbol,N=r.JSON,C=N&&N.stringify,k="prototype",F=d("_hidden"),q=d("toPrimitive"),I={}.propertyIsEnumerable,B=s("symbol-registry"),D=s("symbols"),W=s("op-symbols"),H=Object[k],K="function"==typeof L,R=r.QObject,J=!R||!R[k]||!R[k].findChild,U=i&&a(function(){return 7!=S(A({},"a",{get:function(){return A(this,"a",{value:7}).a}})).a})?function(t,n,e){var r=M(H,n);r&&delete H[n],A(t,n,e),r&&t!==H&&A(H,n,r)}:A,G=function(t){var n=D[t]=S(L[k]);return n._k=t,n},$=K&&"symbol"==typeof L.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof L},z=function(t,n,e){return t===H&&z(W,n,e),m(t),n=w(n,!0),m(e),o(D,n)?(e.enumerable?(o(t,F)&&t[F][n]&&(t[F][n]=!1),e=S(e,{enumerable:O(0,!1)})):(o(t,F)||A(t,F,O(1,{})),t[F][n]=!0),U(t,n,e)):A(t,n,e)},Y=function(t,n){m(t);for(var e,r=b(n=g(n)),o=0,i=r.length;i>o;)z(t,e=r[o++],n[e]);return t},Q=function(t,n){return void 0===n?S(t):Y(S(t),n)},X=function(t){var n=I.call(this,t=w(t,!0));return!(this===H&&o(D,t)&&!o(W,t))&&(!(n||!o(this,t)||!o(D,t)||o(this,F)&&this[F][t])||n)},V=function(t,n){if(t=g(t),n=w(n,!0),t!==H||!o(D,n)||o(W,n)){var e=M(t,n);return!e||!o(D,n)||o(t,F)&&t[F][n]||(e.enumerable=!0),e}},Z=function(t){for(var n,e=T(g(t)),r=[],i=0;e.length>i;)o(D,n=e[i++])||n==F||n==c||r.push(n);return r},tt=function(t){for(var n,e=t===H,r=T(e?W:g(t)),i=[],u=0;r.length>u;)!o(D,n=r[u++])||e&&!o(H,n)||i.push(D[n]);return i};K||(L=function(){if(this instanceof L)throw TypeError("Symbol is not a constructor!");var t=p(arguments.length>0?arguments[0]:void 0),n=function(e){this===H&&n.call(W,e),o(this,F)&&o(this[F],t)&&(this[F][t]=!1),U(this,t,O(1,e))};return i&&J&&U(H,t,{configurable:!0,set:n}),G(t)},f(L[k],"toString",function(){return this._k}),j.f=V,P.f=z,e(33).f=_.f=Z,e(19).f=X,e(34).f=tt,i&&!e(18)&&f(H,"propertyIsEnumerable",X,!0),v.f=function(t){return G(d(t))}),u(u.G+u.W+u.F*!K,{Symbol:L});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),et=0;nt.length>et;)d(nt[et++]);for(var nt=E(d.store),et=0;nt.length>et;)y(nt[et++]);u(u.S+u.F*!K,"Symbol",{for:function(t){return o(B,t+="")?B[t]:B[t]=L(t)},keyFor:function(t){if($(t))return h(B,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){J=!0},useSimple:function(){J=!1}}),u(u.S+u.F*!K,"Object",{create:Q,defineProperty:z,defineProperties:Y,getOwnPropertyDescriptor:V,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),N&&u(u.S+u.F*(!K||a(function(){var t=L();return"[null]"!=C([t])||"{}"!=C({a:t})||"{}"!=C(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!$(t)){for(var n,e,r=[t],o=1;arguments.length>o;)r.push(arguments[o++]);return n=r[1],"function"==typeof n&&(e=n),!e&&x(n)||(n=function(t,n){if(e&&(n=e.call(this,t,n)),!$(n))return n}),r[1]=n,C.apply(N,r)}}}),L[k][q]||e(5)(L[k],q,L[k].valueOf),l(L,"Symbol"),l(Math,"Math",!0),l(r.JSON,"JSON",!0)},function(t,n,e){e(25)("asyncIterator")},function(t,n,e){e(25)("observable")},function(t,n,e){e(62);for(var r=e(1),o=e(5),i=e(17),u=e(7)("toStringTag"),f=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],c=0;c<5;c++){var a=f[c],s=r[a],l=s&&s.prototype;l&&!l[u]&&o(l,u,a),i[a]=i.Array}},function(t,n){"use strict";var e={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&t.indexOf("KHTML")==-1,mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:t.indexOf("Safari")==-1,weixin:t.indexOf("MicroMessenger")==-1}}()};t.exports=e},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}var o=e(40),i=r(o),u=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):o[t]||t}function n(t){return l[t]}var e=/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,r=/['<> "&]/g,o={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},f=/\u00a0/g,c=/<br\s*\/?>/gi,a=/\r?\n/g,s=/\s/g,l={};for(var p in o)l[o[p]]=p;return o["&apos;"]="'",l["'"]="&#39;",{encode:function(t){return t?(""+t).replace(r,n).replace(a,"<br/>").replace(s,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(c,"\n").replace(e,t).replace(f," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e+=2)n.push(String.fromCharCode("0x"+t.slice(e,e+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,e=t.length;e>n;n++)t[n]=u.encodeObject(t[n]);else if("object"==("undefined"==typeof t?"undefined":(0,i.default)(t)))for(var r in t)t[r]=u.encodeObject(t[r]);else if("string"==typeof t)return u.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=u},function(t,n){function e(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=e},function(t,n){function e(t,n){if(t.classList)t.classList.remove(n);else{var e=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(e," ")}}t.exports=e},,,function(t,n){"use strict";function e(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){var n=document.querySelectorAll(".article-entry a:not(.article-more-a)");n.forEach(function(t){t.setAttribute("target","_blank")})}var e=document.querySelector("#js-aboutme");e&&0!==e.length&&(e.innerHTML=e.innerText)}t.exports={init:e}},,,,,,,,,function(t,n){function e(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var e=t.nextSibling;return e?t.parentNode.insertBefore(n,e):t.parentNode.appendChild(n)}t.exports=e}])</script><script src="/./main.234bc0.js"></script><script>!function(){var e=function(e){var t=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(t),t.setAttribute("src",e)};e("/slider.885efe.js")}()</script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
    
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 100%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
        
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">编程语言</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">总结</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">core graph</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">core animation</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">core image</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">image IO</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">runtime</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">block</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">git</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">svn</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">markdown</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">vim</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">vimdiff</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">dash</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">设计模式</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">工厂方法</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">生成器</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">单例</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">scrollView</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">swift</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">spring</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">node</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">公司</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">传统型</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">互联网</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">运营</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">产品</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">买买菌</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">模式</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">产品经理</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">技术</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">管理</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">传统</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">express</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">react</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">架构</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">ES6</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">mysql</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">redis</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">sequelize</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">服务器</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">TDD</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">测试驱动开发</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">UITextKit</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">NSAttributedString</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">hook</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Method Swizzling</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">iOS</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">社会化分享</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">数据同步</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">组件化</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">埋点</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">工具</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">AVFoundation</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">转场</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">重构</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">debug</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">log</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">socket</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">webView</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">image</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">download</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">圆角</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">cornerRadius</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">flex</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">layout</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">AsyncDisplayKit</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">dispatch</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">IGList</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">DDComponent</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">diff</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">IGListKit</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">DDSkin</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">换肤</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">夜间模式</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">DDKeyPathChannel</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">ReativeX</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">RxSwift</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">ReativeCocoa</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">Reactive</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">KVO</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">KVOController</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">MVC</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">MVP</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">MVVM</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">ReSwift</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">Redux</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">测试</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Aspect</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">AOP</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">统计</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">用户行为</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Router</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">路由</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">蘑菇街</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">程序员</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">javascript</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">react-native</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">JSWebviewBridge</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">hybrid</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">weex</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">cordova</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Jasonette</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Tangram</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">缓存</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">Cache</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">数据库</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">realm</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">leveldb</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">navigationBar</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">C++</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">category</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">FBRetainCycleDetector</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">gif</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">property</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">性能</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">调用栈</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">卡顿分析</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">crash</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">stack</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">KSCrash</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">C</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">ARM</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">ASM</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">内存栅栏</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">内存屏障</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">fence</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">barrier</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">GPUImage</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">OpenGL es</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">malloc</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">malloc_zone</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">data-race</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">dead-lock</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">muti-thread</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">functional</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">objc</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">runloop</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">dyld</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">CPU</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Branch Prediction</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">vtable</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">coobjc</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">coroutines</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">UICollectionView</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">跨端</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">h5</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">小程序</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">react native</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">flutter</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Flutter</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">React</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">Image</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Texture</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">文章</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">micro-frontend</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">wakeup</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">XNU</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">wwdc2025</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">ios</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">ipados</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">macos</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">tvos</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">visionos</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">watchos</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">app-store、分发与营销</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">app-服务</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">技术介绍与最佳做法</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">商务-&-教育</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">地图和位置</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">swiftui-和-ui-框架</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">图形和游戏</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">开发者工具</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">系统服务</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">辅助功能和包容性</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">隐私与安全</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">safari-浏览器和网页</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">空间计算</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">机器学习与-ai</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">设计</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">照片和相机</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">音频和视频</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">健康与运动</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            2、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: true
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    

    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>